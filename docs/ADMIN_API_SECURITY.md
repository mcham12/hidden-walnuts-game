# Admin API Security Guide

## How Cloudflare Secrets Work

### Secrets vs Passwords

**Secrets** (Cloudflare Workers):
- Stored in Cloudflare's infrastructure, never in code
- Separate values for preview vs production workers
- Accessed via environment variables: `env.ADMIN_SECRET`
- Managed with Wrangler CLI: `npx wrangler secret put ADMIN_SECRET`
- Never appear in logs or git history

**Passwords** (Traditional):
- Stored in database, compared against user input
- Hashed with bcrypt/argon2
- One-to-many relationship (many users, one secret per user)

**Key Difference**: Secrets authenticate **admins calling APIs**, not users logging in.

---

## Authentication Method

All admin endpoints require authentication via HTTP header:

```
X-Admin-Secret: your-secret-here
```

**Alternative** (for quick browser testing):
```
?admin_secret=your-secret-here
```

**Security Note**: Header method is preferred. Query param method should only be used for quick debugging, never in production scripts.

---

## Calling Admin APIs from macOS Terminal

### Basic Pattern

```bash
curl -X POST https://api.hiddenwalnuts.com/admin/reset-mapstate \
  -H "X-Admin-Secret: YOUR_SECRET_HERE" \
  -H "Content-Type: application/json"
```

### GET Request Example

```bash
curl https://api.hiddenwalnuts.com/admin/players/active \
  -H "X-Admin-Secret: YOUR_SECRET_HERE"
```

### POST with JSON Body

```bash
curl -X POST https://api.hiddenwalnuts.com/admin/npcs/adjust \
  -H "X-Admin-Secret: YOUR_SECRET_HERE" \
  -H "Content-Type: application/json" \
  -d '{"count": 5}'
```

### Pretty-Print JSON Response

```bash
curl https://api.hiddenwalnuts.com/admin/metrics \
  -H "X-Admin-Secret: YOUR_SECRET_HERE" \
  | jq .
```

---

## Calling from Future Admin Web Page

### JavaScript Fetch API

```javascript
// Store secret in sessionStorage (client-side only, not localStorage)
sessionStorage.setItem('adminSecret', 'YOUR_SECRET_HERE');

// Make API call
async function resetMapState() {
  const secret = sessionStorage.getItem('adminSecret');

  const response = await fetch('https://api.hiddenwalnuts.com/admin/reset-mapstate', {
    method: 'POST',
    headers: {
      'X-Admin-Secret': secret,
      'Content-Type': 'application/json'
    }
  });

  if (response.status === 401) {
    alert('Unauthorized - check your admin secret');
    return;
  }

  const data = await response.json();
  console.log('Success:', data);
}
```

### Error Handling Pattern

```javascript
async function callAdminAPI(endpoint, method = 'GET', body = null) {
  const secret = sessionStorage.getItem('adminSecret');

  if (!secret) {
    throw new Error('Admin secret not set');
  }

  const options = {
    method,
    headers: {
      'X-Admin-Secret': secret,
      'Content-Type': 'application/json'
    }
  };

  if (body) {
    options.body = JSON.stringify(body);
  }

  const response = await fetch(`https://api.hiddenwalnuts.com${endpoint}`, options);

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'API call failed');
  }

  return response.json();
}

// Usage
try {
  const metrics = await callAdminAPI('/admin/metrics');
  console.log('Active players:', metrics.activeUsers);
} catch (error) {
  console.error('Admin API error:', error.message);
}
```

---

## Preview vs Production Environments

### Production Worker
- **Name**: `hidden-walnuts-api`
- **URL**: `https://api.hiddenwalnuts.com`
- **Secret**: Set via `npx wrangler secret put ADMIN_SECRET` (no flags)
- **Use for**: Live game operations

### Preview Worker
- **Name**: `hidden-walnuts-api-preview`
- **URL**: Auto-generated by Cloudflare (e.g., `https://hidden-walnuts-api-preview.username.workers.dev`)
- **Secret**: Set via `npx wrangler secret put ADMIN_SECRET --env preview`
- **Use for**: Testing changes before production

### Important Notes

1. **Separate Secrets**: Preview and production have different `ADMIN_SECRET` values
2. **Separate Data**: Preview and production use different Durable Object instances
3. **Testing Flow**: Always test admin operations in preview before running in production
4. **No Cross-Contamination**: Preview operations never affect production data

### Example: Testing in Preview

```bash
# Get preview URL from wrangler
npx wrangler tail --env preview

# Test admin API in preview
curl https://your-preview-url.workers.dev/admin/players/active \
  -H "X-Admin-Secret: YOUR_PREVIEW_SECRET"
```

---

## Security Best Practices

### ✅ DO:
- Store secrets in sessionStorage (web) or environment variables (terminal)
- Use HTTPS for all admin API calls
- Rotate secrets periodically (every 90 days)
- Use different secrets for preview vs production
- Log all admin actions (coming in future MVP)

### ❌ DON'T:
- Never commit secrets to git
- Never put secrets in client-side code (HTML/JS files)
- Never log secrets (they won't appear in Cloudflare logs anyway)
- Never share secrets in Slack/email (use password manager)
- Never use production secret in preview environment

---

## Secret Rotation

### When to Rotate:
- Every 90 days (good practice)
- After team member with access leaves
- If secret may have been compromised
- Before public launch (if testing with temporary secret)

### How to Rotate:

**Step 1: Set new secret**
```bash
# Production
npx wrangler secret put ADMIN_SECRET
# Enter new secret when prompted

# Preview
npx wrangler secret put ADMIN_SECRET --env preview
# Enter new secret when prompted
```

**Step 2: Update local scripts**
- Update any saved curl commands
- Update admin dashboard login
- Notify team members

**Step 3: Test**
```bash
# Verify old secret fails
curl https://api.hiddenwalnuts.com/admin/metrics \
  -H "X-Admin-Secret: old-secret-here"
# Should return 401 Unauthorized

# Verify new secret works
curl https://api.hiddenwalnuts.com/admin/metrics \
  -H "X-Admin-Secret: new-secret-here"
# Should return metrics
```

---

## Troubleshooting

### "Unauthorized" Error (401)

**Possible causes:**
1. Wrong secret value
2. Using preview secret on production (or vice versa)
3. Secret not set (check with `npx wrangler secret list`)
4. Typo in header name (must be exactly `X-Admin-Secret`)

**How to fix:**
```bash
# Check if secret exists
npx wrangler secret list

# Set or update secret
npx wrangler secret put ADMIN_SECRET
```

### "Not Found" Error (404)

**Possible causes:**
1. Wrong endpoint URL
2. Typo in endpoint path
3. Using HTTP instead of HTTPS

**How to fix:**
- Check endpoint path in API reference
- Ensure URL starts with `https://`
- Verify worker is deployed: `npx wrangler deploy`

### CORS Errors (from browser)

**Symptom**: Admin API works in curl but fails in browser with CORS error

**Cause**: Admin endpoints may need CORS headers for browser access

**Fix**: Admin endpoints include CORS headers automatically (implemented in ForestManager)

---

## Quick Reference

### Get Admin Secret (if you have Wrangler access)
```bash
# Production
npx wrangler secret list

# Preview
npx wrangler secret list --env preview
```

### Set Admin Secret
```bash
# Production
npx wrangler secret put ADMIN_SECRET

# Preview
npx wrangler secret put ADMIN_SECRET --env preview
```

### Test Authentication
```bash
# Should fail (401)
curl https://api.hiddenwalnuts.com/admin/metrics

# Should succeed (200)
curl https://api.hiddenwalnuts.com/admin/metrics \
  -H "X-Admin-Secret: YOUR_SECRET"
```
