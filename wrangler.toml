name = "hidden-walnuts-api"

# CHEN'S FIX: Correct entry point for workers
main = "workers/dist/worker/api.js"

compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

[build]
command = "npm run build"

# Enable logging for debugging
[observability.logs]
enabled = true

# Environment variables (merged properly)
[vars]
# Environment configuration - set to 'development' for local testing
ENVIRONMENT = "development"
CYCLE_DURATION_SECONDS = "86400"  # 24 hours in seconds

# MVP 9: Leaderboard reset configuration
LEADERBOARD_RESET_ENABLED = "true"  # Enable weekly auto-reset
LEADERBOARD_RESET_DAY = "1"  # Monday (0=Sunday, 1=Monday, etc.)
LEADERBOARD_ARCHIVE_LIMIT = "12"  # Keep last 12 weeks of archives

# KV Namespaces for leaderboard archives
[[kv_namespaces]]
binding = "LEADERBOARD_ARCHIVES"
id = "ba952f7d616541f7be6a6a9ffbadc93b"  # Created via: npx wrangler kv namespace create "LEADERBOARD_ARCHIVES"

# MVP 16: Email uniqueness index for authentication
[[kv_namespaces]]
binding = "EMAIL_INDEX"
id = "1c7b48760aae43c891eddeeae77c2030"
preview_id = "21344757db994f7bb7a9cb31862128d4"

# MVP 7.1: Rate Limiting for bot protection
[[unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
# Namespace ID - any unique positive integer for your account
namespace_id = "1001"
# Simple mode - 100 requests per 60 seconds per key
simple = { limit = 100, period = 60 }

# Durable Objects configuration (matching preview/production names)
[[durable_objects.bindings]]
name = "SQUIRREL"
class_name = "SquirrelSession"

[[durable_objects.bindings]]
name = "FOREST"
class_name = "ForestManager"

[[durable_objects.bindings]]
name = "WALNUTS"
class_name = "WalnutRegistry"

[[durable_objects.bindings]]
name = "LEADERBOARD"
class_name = "Leaderboard"

[[durable_objects.bindings]]
name = "PLAYER_IDENTITY"
class_name = "PlayerIdentity"

# Durable Objects migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = [
  "ForestManager",
  "SquirrelSession",
  "WalnutRegistry",
  "Leaderboard"
]

[[migrations]]
tag = "v2"
# v2 migration - maintaining consistency with deployed version
# No changes needed as classes already exist

[[migrations]]
tag = "v3"
# MVP 6: Player Identity - Session token â†’ username mapping
new_sqlite_classes = ["PlayerIdentity"]

# MVP 15: Cron triggers for daily reset and weekly leaderboard reset
# CST is UTC-6, so 2am CST = 8am UTC
[triggers]
crons = [
  "0 8 * * *",    # Daily reset at 8am UTC (2am CST)
  "5 8 * * 1"     # Weekly leaderboard reset at 8:05am UTC on Sunday (2:05am CST) - Note: 1=Sunday in Cloudflare
]

# Note: No environment-specific config needed
# Separate workers (hidden-walnuts-api and hidden-walnuts-api-preview)
# both use the base configuration above
# Differences handled via:
# - Separate worker names in deployment
# - Separate secrets (TURNSTILE_SECRET, ADMIN_SECRET) per worker
# - Custom domain (api.hiddenwalnuts.com) only on production worker