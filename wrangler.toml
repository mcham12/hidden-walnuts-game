name = "hidden-walnuts-api"

# CHEN'S FIX: Correct entry point for workers
main = "workers/dist/worker/api.js"

compatibility_date = "2024-01-01"

[build]
command = "npm run build"

# Enable logging for debugging
[observability.logs]
enabled = true

# Environment variables (merged properly)
[vars]
# Environment configuration - set to 'development' for local testing
ENVIRONMENT = "development"
CYCLE_DURATION_SECONDS = "86400"  # 24 hours in seconds

# MVP 7.1: Rate Limiting for bot protection
[[unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
# Namespace ID - any unique positive integer for your account
namespace_id = "1001"
# Simple mode - 100 requests per 60 seconds per key
simple = { limit = 100, period = 60 }

# Durable Objects configuration (matching preview/production names)
[[durable_objects.bindings]]
name = "SQUIRREL"
class_name = "SquirrelSession"

[[durable_objects.bindings]]
name = "FOREST"
class_name = "ForestManager"

[[durable_objects.bindings]]
name = "WALNUTS"
class_name = "WalnutRegistry"

[[durable_objects.bindings]]
name = "LEADERBOARD"
class_name = "Leaderboard"

[[durable_objects.bindings]]
name = "PLAYER_IDENTITY"
class_name = "PlayerIdentity"

# Durable Objects migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = [
  "ForestManager",
  "SquirrelSession",
  "WalnutRegistry",
  "Leaderboard"
]

[[migrations]]
tag = "v2"
# v2 migration - maintaining consistency with deployed version
# No changes needed as classes already exist

[[migrations]]
tag = "v3"
# MVP 6: Player Identity - Session token â†’ username mapping
new_sqlite_classes = ["PlayerIdentity"]

# Environment configurations
[env.preview]
workers_dev = true
[env.preview.vars]
ENVIRONMENT = "preview"
CYCLE_DURATION_SECONDS = "86400"
[env.preview.durable_objects]
bindings = [
  { name = "FOREST", class_name = "ForestManager" },
  { name = "SQUIRREL", class_name = "SquirrelSession" },
  { name = "WALNUTS", class_name = "WalnutRegistry" },
  { name = "LEADERBOARD", class_name = "Leaderboard" },
  { name = "PLAYER_IDENTITY", class_name = "PlayerIdentity" }
]
# MVP 7.1: Rate limiting for preview
[[env.preview.unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1001"
simple = { limit = 100, period = 60 }

[env.production]
workers_dev = false
[env.production.vars]
ENVIRONMENT = "production"
CYCLE_DURATION_SECONDS = "86400"
[env.production.durable_objects]
bindings = [
  { name = "FOREST", class_name = "ForestManager" },
  { name = "SQUIRREL", class_name = "SquirrelSession" },
  { name = "WALNUTS", class_name = "WalnutRegistry" },
  { name = "LEADERBOARD", class_name = "Leaderboard" },
  { name = "PLAYER_IDENTITY", class_name = "PlayerIdentity" }
]
# MVP 7.1: Rate limiting for production
[[env.production.unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1001"
simple = { limit = 100, period = 60 }