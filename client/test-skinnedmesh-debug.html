<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkinnedMesh Debug Tool</title>
    <style>
        body { margin: 0; font-family: monospace; }
        #controls { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; }
        #log { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; max-width: 500px; max-height: 600px; overflow-y: auto; }
        button { margin: 2px; padding: 5px; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <div id="controls">
        <h3>SkinnedMesh Debug Tool</h3>
        <button onclick="testSquirrel()">Test Squirrel</button>
        <button onclick="testColobus()">Test Colobus</button>
        <button onclick="testCloning()">Test Cloning Impact</button>
        <button onclick="clearScene()">Clear Scene</button>
        <br><br>
        <div id="results"></div>
    </div>
    <div id="log"></div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

        let scene, camera, renderer, controls;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const groundGeometry = new THREE.PlaneGeometry(20, 20);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            log('Scene initialized', 'success');
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function analyzeSkinnedMesh(model, name) {
            log(`=== Analyzing ${name} ===`, 'info');
            
            let meshCount = 0;
            let skinnedMeshCount = 0;
            let boneCount = 0;
            let skeletonCount = 0;
            let materialCount = 0;
            let visibleCount = 0;
            let invisibleCount = 0;
            
            model.traverse((child) => {
                const isMesh = child instanceof THREE.Mesh;
                const isSkinnedMesh = child instanceof THREE.SkinnedMesh;
                const isBone = child instanceof THREE.Bone;
                
                if (isMesh) {
                    meshCount++;
                    if (child.material) materialCount++;
                    if (child.visible) visibleCount++;
                    else invisibleCount++;
                } else if (isSkinnedMesh) {
                    skinnedMeshCount++;
                    if (child.material) materialCount++;
                    if (child.visible) visibleCount++;
                    else invisibleCount++;
                    
                    // Check skeleton
                    if (child.skeleton) {
                        skeletonCount++;
                        log(`  - SkinnedMesh has skeleton: ${!!child.skeleton}`, 'info');
                        log(`  - Skeleton bones: ${child.skeleton.bones.length}`, 'info');
                        log(`  - Skeleton boneInverses: ${child.skeleton.boneInverses.length}`, 'info');
                    } else {
                        log(`  - ⚠️ SkinnedMesh has NO skeleton!`, 'warning');
                    }
                } else if (isBone) {
                    boneCount++;
                }
            });
            
            log(`  - Mesh count: ${meshCount}`, 'info');
            log(`  - SkinnedMesh count: ${skinnedMeshCount}`, 'info');
            log(`  - Bone count: ${boneCount}`, 'info');
            log(`  - Skeleton count: ${skeletonCount}`, 'info');
            log(`  - Material count: ${materialCount}`, 'info');
            log(`  - Visible objects: ${visibleCount}`, 'info');
            log(`  - Invisible objects: ${invisibleCount}`, 'info');
            log(`  - Model visible: ${model.visible}`, 'info');
            
            return {
                meshCount,
                skinnedMeshCount,
                boneCount,
                skeletonCount,
                materialCount,
                visibleCount,
                invisibleCount,
                modelVisible: model.visible
            };
        }

        async function loadModel(path, name) {
            try {
                log(`Loading ${name} from ${path}...`, 'info');
                
                const loader = new GLTFLoader();
                const gltf = await loader.loadAsync(path);
                
                if (!gltf || !gltf.scene) {
                    throw new Error('Model loaded but scene is null');
                }
                
                const model = gltf.scene;
                log(`✅ ${name} loaded successfully`, 'success');
                
                // Check for animations
                if (gltf.animations && gltf.animations.length > 0) {
                    log(`  - Animations found: ${gltf.animations.length}`, 'info');
                    gltf.animations.forEach((anim, index) => {
                        log(`    - Animation ${index}: ${anim.name} (${anim.duration.toFixed(2)}s)`, 'info');
                    });
                } else {
                    log(`  - No animations found`, 'warning');
                }
                
                return { model, gltf };
            } catch (error) {
                log(`❌ Failed to load ${name}: ${error.message}`, 'error');
                return null;
            }
        }

        async function testSquirrel() {
            log('=== Testing Squirrel Model ===', 'info');
            
            const result = await loadModel('/assets/models/environment/squirrel.glb', 'Squirrel');
            if (!result) return;
            
            const { model } = result;
            model.scale.set(0.3, 0.3, 0.3);
            model.position.set(-3, 0.1, 0);
            model.castShadow = true;
            model.receiveShadow = true;
            
            scene.add(model);
            
            const analysis = analyzeSkinnedMesh(model, 'Squirrel');
            
            log('✅ Squirrel test completed', 'success');
        }

        async function testColobus() {
            log('=== Testing Colobus Model ===', 'info');
            
            const result = await loadModel('/assets/models/characters/Colobus_LOD0.glb', 'Colobus');
            if (!result) return;
            
            const { model } = result;
            model.scale.set(0.3, 0.3, 0.3);
            model.position.set(0, 0.1, 0);
            model.castShadow = true;
            model.receiveShadow = true;
            
            scene.add(model);
            
            const analysis = analyzeSkinnedMesh(model, 'Colobus');
            
            log('✅ Colobus test completed', 'success');
        }

        async function testCloning() {
            log('=== Testing Cloning Impact ===', 'info');
            
            // Clear scene
            while(scene.children.length > 0) {
                scene.remove(scene.children[0]);
            }
            
            // Re-add lighting and ground
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            const groundGeometry = new THREE.PlaneGeometry(20, 20);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Test original colobus
            const result = await loadModel('/assets/models/characters/Colobus_LOD0.glb', 'Colobus');
            if (!result) return;
            
            const originalModel = result.model;
            originalModel.scale.set(0.3, 0.3, 0.3);
            originalModel.position.set(-3, 0.1, 0);
            originalModel.castShadow = true;
            originalModel.receiveShadow = true;
            scene.add(originalModel);
            
            const originalAnalysis = analyzeSkinnedMesh(originalModel, 'Colobus (Original)');
            
            // Test cloned colobus
            const clonedModel = originalModel.clone();
            clonedModel.scale.set(0.3, 0.3, 0.3);
            clonedModel.position.set(3, 0.1, 0);
            clonedModel.castShadow = true;
            clonedModel.receiveShadow = true;
            scene.add(clonedModel);
            
            const clonedAnalysis = analyzeSkinnedMesh(clonedModel, 'Colobus (Cloned)');
            
            // Compare results
            log('=== Cloning Comparison ===', 'info');
            log(`SkinnedMesh count - Original: ${originalAnalysis.skinnedMeshCount}, Cloned: ${clonedAnalysis.skinnedMeshCount}`, 'info');
            log(`Bone count - Original: ${originalAnalysis.boneCount}, Cloned: ${clonedAnalysis.boneCount}`, 'info');
            log(`Skeleton count - Original: ${originalAnalysis.skeletonCount}, Cloned: ${clonedAnalysis.skeletonCount}`, 'info');
            log(`Visible objects - Original: ${originalAnalysis.visibleCount}, Cloned: ${clonedAnalysis.visibleCount}`, 'info');
            
            if (originalAnalysis.skinnedMeshCount !== clonedAnalysis.skinnedMeshCount) {
                log('⚠️ WARNING: SkinnedMesh count changed after cloning!', 'warning');
            }
            if (originalAnalysis.skeletonCount !== clonedAnalysis.skeletonCount) {
                log('⚠️ WARNING: Skeleton count changed after cloning!', 'warning');
            }
            if (originalAnalysis.visibleCount !== clonedAnalysis.visibleCount) {
                log('⚠️ WARNING: Visible object count changed after cloning!', 'warning');
            }
            
            log('✅ Cloning test completed', 'success');
        }

        function clearScene() {
            while(scene.children.length > 0) {
                scene.remove(scene.children[0]);
            }
            log('Scene cleared', 'info');
        }

        // Make functions globally available
        window.testSquirrel = testSquirrel;
        window.testColobus = testColobus;
        window.testCloning = testCloning;
        window.clearScene = clearScene;

        init();
    </script>
</body>
</html> 