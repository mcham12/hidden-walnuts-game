<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Hidden Walnuts</title>
    <style>
      /* CRITICAL: Prevent iOS Safari white space issues - Use CSS variable set by JS */
      :root {
        --app-height: 100vh; /* Fallback, will be set by JavaScript */
      }
      html {
        width: 100vw;
        height: var(--app-height);
        margin: 0;
        padding: 0;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
      }
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        width: 100vw;
        height: var(--app-height);
        position: fixed;
        top: 0;
        left: 0;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: none;
      }
      /* CRITICAL: Only style the GAME canvas, not preview canvas */
      #gameCanvas {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: var(--app-height);
        z-index: 0; /* Behind all UI */
        pointer-events: auto;
        touch-action: pan-y;
        /* Prevent iOS white space */
        -webkit-transform: translate3d(0, 0, 0);
        transform: translate3d(0, 0, 0);
      }
      #gameCanvas.hidden {
        display: none;
      }
      /* MVP 5.8: Character Selection - Forest Theme (matches Welcome Screen) */
      #character-select {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #1a4620 0%, #2d5f2e 50%, #4a8f4d 100%);
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        font-family: 'Arial', sans-serif;
        min-width: 550px;
        z-index: 9000;
        display: flex;
        flex-direction: column;
        gap: 20px;
        border: 3px solid rgba(255, 215, 0, 0.3);
      }
      #character-preview-container {
        width: 100%;
        height: 280px;
        background: linear-gradient(135deg, #2d5f2e 0%, #4a8f4d 100%);
        border-radius: 12px;
        border: 3px solid rgba(255, 215, 0, 0.4);
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      #character-preview-canvas {
        width: 100%;
        height: 100%;
        display: block;
      }
      #character-select.hidden {
        display: none;
      }
      #character-select h3 {
        margin: 0 0 10px 0;
        color: #FFD700;
        font-size: 32px;
        text-align: center;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        font-weight: 800;
        letter-spacing: 1px;
      }
      #character-select select {
        width: 100%;
        padding: 14px;
        font-size: 17px;
        border: 2px solid rgba(255, 215, 0, 0.5);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.95);
        cursor: pointer;
        font-weight: 600;
        color: #2c5f2d;
        transition: all 0.2s;
      }
      #character-select select:focus {
        outline: none;
        border-color: #FFD700;
        box-shadow: 0 0 12px rgba(255, 215, 0, 0.4);
      }
      #character-select select:hover {
        border-color: #FFD700;
      }
      #char-description {
        background: rgba(0, 0, 0, 0.3);
        padding: 16px;
        border-radius: 8px;
        min-height: 60px;
        font-size: 15px;
        color: #FFE4B5;
        line-height: 1.6;
        border: 1px solid rgba(255, 215, 0, 0.2);
      }
      #char-description strong {
        color: #FFD700;
        display: block;
        margin-bottom: 6px;
        font-size: 17px;
      }
      #start-btn {
        width: 100%;
        padding: 18px;
        font-size: 22px;
        font-weight: bold;
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: #2c5f2d;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4);
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      #start-btn:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 12px 32px rgba(255, 215, 0, 0.6);
      }
      #start-btn:active {
        transform: translateY(-1px) scale(1.01);
      }
      #debug-overlay {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        z-index: 1100;
      }
      #debug-overlay.hidden {
        display: none;
      }
      #walnut-hud {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        top: 10px;
        left: 10px;
        background: rgba(139, 69, 19, 0.9);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        pointer-events: none; /* Let touches pass through to canvas */
      }
      #walnut-hud.hidden {
        display: none;
      }
      #walnut-hud div {
        margin: 4px 0;
      }
      /* HIDE INSTRUCTIONS FOR ALL PLATFORMS - cleaner HUD */
      #walnut-hud hr {
        display: none !important;
      }
      #walnut-hud div:nth-child(4) {
        display: none !important; /* Instructions text */
      }
      .walnut-icon {
        display: inline-block;
        width: 20px;
        height: 20px;
        background: radial-gradient(circle, #8B4513 0%, #654321 100%);
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
      }
      /* MVP 8 Phase 3: Health Bar Styles (Desktop/Default) */
      #health-container {
        margin-top: 4px;
      }
      .landmark-label {
        position: absolute;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        pointer-events: none;
        white-space: nowrap;
        transform: translate(-50%, -100%);
      }
      #minimap {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        top: 10px;
        right: 10px;
        width: 200px;
        height: 200px;
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        z-index: 1000;
        display: none; /* MVP 5.7: Hidden by default, shown after game starts */
        pointer-events: none; /* Let touches pass through to canvas */
      }
      #minimap.visible {
        display: block;
      }
      #minimap canvas {
        width: 100%;
        height: 100%;
        border-radius: 6px;
      }
      #tutorial-overlay.hidden {
        display: none !important;
      }
      #leaderboard {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        top: 10px;
        right: 220px;
        width: 250px;
        background: rgba(44, 95, 45, 0.95);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      }
      #leaderboard.hidden {
        display: none;
      }
      #leaderboard h3 {
        margin: 0 0 10px 0;
        font-size: 18px;
        text-align: center;
        color: #FFD700;
        border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        padding-bottom: 8px;
      }
      #leaderboard-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      #leaderboard-list li {
        padding: 8px;
        margin: 4px 0;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
      }
      #leaderboard-list li:hover {
        background: rgba(0, 0, 0, 0.3);
      }
      #leaderboard-list li.current-player {
        background: rgba(255, 215, 0, 0.2);
        border: 1px solid rgba(255, 215, 0, 0.5);
      }
      .leaderboard-rank {
        font-weight: bold;
        color: #FFD700;
        min-width: 25px;
      }
      .leaderboard-name {
        flex: 1;
        margin: 0 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .leaderboard-score {
        font-weight: bold;
        color: #FFE4B5;
      }
      #leaderboard-toggle {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        top: 10px;
        right: 475px;
        background: rgba(44, 95, 45, 0.9);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        font-weight: bold;
        z-index: 1001;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.2s;
        pointer-events: auto;
        touch-action: manipulation;
      }
      #leaderboard-toggle:hover {
        background: rgba(44, 95, 45, 1);
        transform: translateY(-1px);
      }
      #leaderboard-toggle.hidden {
        display: none;
      }
      #quick-chat {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        bottom: 20px;
        left: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 1000;
      }
      #quick-chat.hidden {
        display: none;
      }
      .chat-button {
        background: rgba(44, 95, 45, 0.9);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Arial', sans-serif;
        font-size: 13px;
        font-weight: bold;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        min-width: 150px;
        text-align: left;
        pointer-events: auto;
        touch-action: manipulation;
      }
      .chat-button:hover {
        background: rgba(44, 95, 45, 1);
        transform: translateX(3px);
      }
      #emotes {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 8px;
        z-index: 1000;
      }
      #emotes.hidden {
        display: none;
      }
      .emote-button {
        background: rgba(139, 69, 19, 0.9);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        width: 50px;
        height: 50px;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: auto;
        touch-action: manipulation;
      }
      .emote-button:hover {
        background: rgba(139, 69, 19, 1);
        transform: scale(1.1);
      }
      #chat-message-display {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        bottom: 200px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        max-width: 300px;
        display: none;
        z-index: 1001;
      }
      #chat-message-display.show {
        display: block;
        animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
      /* MVP 5: Settings Menu Styles */
      #settings-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2500;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #settings-overlay.hidden {
        display: none;
      }
      #settings-menu {
        background: linear-gradient(135deg, #2c5f2d 0%, #4a8f4d 100%);
        border-radius: 12px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 12px 32px rgba(0,0,0,0.5);
        font-family: 'Arial', sans-serif;
        color: white;
      }
      #settings-menu h2 {
        margin: 0 0 20px 0;
        font-size: 28px;
        text-align: center;
        color: #FFD700;
      }
      .settings-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid rgba(255,255,255,0.3);
      }
      .settings-tab {
        padding: 10px 20px;
        background: rgba(0,0,0,0.2);
        border: none;
        border-radius: 8px 8px 0 0;
        color: rgba(255,255,255,0.7);
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      }
      .settings-tab:hover {
        background: rgba(0,0,0,0.3);
        color: white;
      }
      .settings-tab.active {
        background: rgba(255,255,255,0.2);
        color: white;
        border-bottom: 3px solid #FFD700;
      }
      .settings-content {
        display: none;
        padding: 20px;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
        min-height: 300px;
      }
      .settings-content.active {
        display: block;
      }
      .setting-group {
        margin-bottom: 25px;
      }
      .setting-group label {
        display: block;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 8px;
        color: #FFE4B5;
      }
      .setting-group input[type="range"] {
        width: 100%;
        height: 8px;
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
        outline: none;
        cursor: pointer;
      }
      .setting-group input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        background: #FFD700;
        border-radius: 50%;
        cursor: pointer;
      }
      .setting-group input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #FFD700;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }
      .slider-value {
        display: inline-block;
        min-width: 40px;
        text-align: right;
        font-weight: bold;
        color: white;
        margin-left: 10px;
      }
      .controls-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
      }
      .control-item {
        background: rgba(0,0,0,0.3);
        padding: 12px;
        border-radius: 6px;
      }
      .control-key {
        display: inline-block;
        background: rgba(255,215,0,0.3);
        padding: 4px 12px;
        border-radius: 4px;
        font-weight: bold;
        color: #FFD700;
        margin-right: 8px;
        min-width: 50px;
        text-align: center;
      }
      .settings-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: center;
      }
      .settings-button {
        padding: 12px 30px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      }
      .settings-button.primary {
        background: rgba(255,215,0,0.9);
        color: #2c5f2d;
      }
      .settings-button.primary:hover {
        background: rgba(255,215,0,1);
        transform: translateY(-2px);
      }
      .settings-button.secondary {
        background: rgba(0,0,0,0.3);
        color: white;
      }
      .settings-button.secondary:hover {
        background: rgba(0,0,0,0.4);
      }
      #settings-toggle {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        top: 220px;
        right: 10px;
        background: rgba(44, 95, 45, 0.9);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        font-weight: bold;
        z-index: 1001;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.2s;
        pointer-events: auto;
        touch-action: manipulation;
      }
      #settings-toggle:hover {
        background: rgba(44, 95, 45, 1);
        transform: translateY(-1px);
      }
      #settings-toggle.hidden {
        display: none;
      }
      /* MVP 5: Persistent Control Guide */
      #control-guide {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-family: 'Arial', sans-serif;
        font-size: 13px;
        z-index: 1000;
        display: flex;
        gap: 20px;
        align-items: center;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transition: opacity 0.3s ease;
      }
      #control-guide.hidden {
        display: none;
      }
      #control-guide-close {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      #control-guide-close:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
      }
      .control-item-inline {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .control-key-inline {
        background: rgba(255,255,255,0.2);
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 12px;
        color: #FFD700;
        min-width: 30px;
        text-align: center;
      }
      .control-separator {
        color: rgba(255,255,255,0.3);
        font-weight: bold;
      }
      /* MVP 5: Loading Progress Bar */
      #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a3a1c 0%, #2c5f2d 100%);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-family: 'Arial', sans-serif;
      }
      #loading-screen.hidden {
        display: none;
      }
      #loading-title {
        font-size: 48px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #FFD700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      }
      #loading-progress-container {
        width: 400px;
        height: 30px;
        background: rgba(0,0,0,0.3);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        margin-bottom: 15px;
      }
      #loading-progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
        transition: width 0.3s ease;
        box-shadow: 0 0 10px rgba(255,215,0,0.5);
      }
      #loading-text {
        font-size: 18px;
        color: #FFE4B5;
        margin-bottom: 10px;
      }
      #loading-percentage {
        font-size: 24px;
        font-weight: bold;
        color: #FFD700;
      }

      /* MVP 5.8: Welcome Screen */
      #welcome-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a4620 0%, #2d5f2e 50%, #4a8f4d 100%);
        z-index: 10000;
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }
      .welcome-content {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 50px;
        z-index: 2;
        padding: 20px;
      }
      /* Title and tagline */
      .welcome-text {
        text-align: center;
        color: white;
        font-family: 'Arial', sans-serif;
      }
      .welcome-title {
        font-size: 72px;
        font-weight: 800;
        margin: 0;
        color: #FFD700;
        text-shadow: 4px 4px 8px rgba(0,0,0,0.7);
        letter-spacing: 2px;
      }
      .welcome-tagline {
        font-size: 24px;
        margin: 15px 0 0 0;
        color: #FFE4B5;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        font-weight: 300;
        letter-spacing: 1px;
      }
      /* Welcome form */
      .welcome-form {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        width: 100%;
        max-width: 500px;
      }
      .welcome-label {
        font-size: 22px;
        color: #FFE4B5;
        font-weight: 600;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        font-family: 'Arial', sans-serif;
      }
      .welcome-input {
        width: 100%;
        padding: 18px 24px;
        font-size: 20px;
        border: 3px solid rgba(255, 215, 0, 0.5);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.95);
        color: #2c5f2d;
        font-family: 'Arial', sans-serif;
        font-weight: 600;
        text-align: center;
        outline: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .welcome-input::placeholder {
        color: rgba(44, 95, 45, 0.5);
        font-weight: 400;
      }
      .welcome-input:focus {
        border-color: #FFD700;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
      }
      /* Enter button */
      .welcome-button {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: #2c5f2d;
        border: none;
        padding: 20px 60px;
        border-radius: 50px;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4);
        transition: all 0.3s ease;
        font-family: 'Arial', sans-serif;
        text-transform: uppercase;
        letter-spacing: 2px;
        width: 100%;
        max-width: 400px;
      }
      .welcome-button:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 12px 32px rgba(255, 215, 0, 0.6);
      }
      .welcome-button:active {
        transform: translateY(-2px) scale(1.01);
      }
      /* Decorative elements */
      .forest-rays {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg,
          transparent 0%,
          rgba(255, 255, 255, 0.03) 25%,
          transparent 50%,
          rgba(255, 255, 255, 0.03) 75%,
          transparent 100%);
        background-size: 200% 200%;
        animation: forestRays 15s ease-in-out infinite;
        z-index: 1;
        pointer-events: none;
      }
      @keyframes forestRays {
        0%, 100% { opacity: 0.3; transform: rotate(0deg); }
        50% { opacity: 0.6; transform: rotate(2deg); }
      }
      /* Floating leaves */
      .floating-leaf {
        position: absolute;
        font-size: 32px;
        opacity: 0.6;
        animation: floatLeaf 8s ease-in-out infinite;
        z-index: 1;
        pointer-events: none;
      }
      .leaf-1 {
        top: 10%;
        left: 15%;
        animation-delay: 0s;
        animation-duration: 10s;
      }
      .leaf-2 {
        top: 70%;
        left: 80%;
        animation-delay: 2s;
        animation-duration: 12s;
      }
      .leaf-3 {
        top: 30%;
        right: 10%;
        animation-delay: 4s;
        animation-duration: 9s;
      }
      .leaf-4 {
        bottom: 20%;
        left: 25%;
        animation-delay: 6s;
        animation-duration: 11s;
      }
      @keyframes floatLeaf {
        0%, 100% {
          transform: translateY(0px) rotate(0deg);
          opacity: 0.4;
        }
        50% {
          transform: translateY(-30px) rotate(180deg);
          opacity: 0.8;
        }
      }

      /* Responsive: iPad Landscape */
      @media (max-width: 1024px) and (orientation: landscape) {
        .welcome-title {
          font-size: 56px;
        }
        .welcome-tagline {
          font-size: 20px;
        }
        .welcome-label {
          font-size: 20px;
        }
        .welcome-input {
          padding: 16px 20px;
          font-size: 18px;
        }
        .welcome-button {
          padding: 16px 48px;
          font-size: 20px;
        }
        .welcome-content {
          gap: 35px;
        }
        .welcome-form {
          max-width: 450px;
        }
      }

      /* Responsive: iPad Portrait */
      @media (max-width: 768px) and (orientation: portrait) {
        .welcome-title {
          font-size: 52px;
        }
        .welcome-tagline {
          font-size: 18px;
        }
        .welcome-label {
          font-size: 19px;
        }
        .welcome-input {
          padding: 16px 20px;
          font-size: 18px;
        }
        .welcome-button {
          padding: 18px 50px;
          font-size: 22px;
        }
        .welcome-form {
          max-width: 420px;
        }
      }

      /* Responsive: iPhone Portrait */
      @media (max-width: 430px) {
        .welcome-title {
          font-size: 42px;
        }
        .welcome-tagline {
          font-size: 16px;
        }
        .welcome-label {
          font-size: 18px;
        }
        .welcome-input {
          padding: 16px 18px;
          font-size: 17px;
        }
        .welcome-button {
          padding: 16px 40px;
          font-size: 18px;
        }
        .welcome-content {
          gap: 30px;
          padding: 15px;
        }
        .welcome-form {
          max-width: 100%;
          gap: 16px;
        }
        .floating-leaf {
          font-size: 24px;
        }
      }

      /* Responsive: iPhone Landscape (CRITICAL) - Horizontal layout */
      @media (max-height: 500px) and (orientation: landscape) {
        .welcome-content {
          flex-direction: row;
          gap: 30px;
          padding: 15px;
          justify-content: space-around;
          align-items: center;
        }
        .welcome-text {
          text-align: left;
          flex-shrink: 0;
        }
        .welcome-title {
          font-size: 32px;
        }
        .welcome-tagline {
          font-size: 14px;
          margin-top: 8px;
        }
        .welcome-form {
          max-width: 350px;
          gap: 12px;
        }
        .welcome-label {
          font-size: 15px;
        }
        .welcome-input {
          padding: 12px 16px;
          font-size: 15px;
        }
        .welcome-button {
          padding: 12px 32px;
          font-size: 16px;
        }
        .floating-leaf {
          font-size: 20px;
        }
      }

      /* MVP 5: Toast Notification System */
      #toast-container {
        position: fixed;
        top: 50px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }
      .toast {
        background: rgba(44, 95, 45, 0.95);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        min-width: 250px;
        max-width: 400px;
        pointer-events: auto;
        animation: slideIn 0.3s ease-out;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .toast.success {
        background: rgba(76, 175, 80, 0.95);
        border-left: 4px solid #4CAF50;
      }
      .toast.error {
        background: rgba(244, 67, 54, 0.95);
        border-left: 4px solid #f44336;
      }
      .toast.info {
        background: rgba(33, 150, 243, 0.95);
        border-left: 4px solid #2196F3;
      }
      .toast.warning {
        background: rgba(255, 152, 0, 0.95);
        border-left: 4px solid #FF9800;
      }
      .toast-icon {
        font-size: 20px;
        flex-shrink: 0;
      }
      .toast-message {
        flex: 1;
      }
      .toast.fadeOut {
        animation: slideOut 0.3s ease-in forwards;
      }
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
      /* MVP 5.7: Mobile/Touch-Friendly Styles */
      @media (max-width: 768px), (hover: none) and (pointer: coarse) {
        /* Make character select mobile-friendly - Forest Theme */
        #character-select {
          min-width: auto;
          width: 95%;
          max-width: 450px;
          padding: 20px;
          gap: 15px;
        }
        #character-select h3 {
          font-size: 24px;
          margin-bottom: 5px;
        }
        #character-preview-container {
          height: 200px;
        }
        #char-description {
          padding: 12px;
          font-size: 14px;
          min-height: 50px;
        }
        #character-select select {
          font-size: 16px;
          padding: 14px;
          min-height: 52px; /* Touch target minimum */
        }
        #start-btn {
          padding: 18px;
          font-size: 20px;
          min-height: 60px; /* Touch target minimum */
        }

        /* Make HUD mobile-friendly - HIDE INSTRUCTIONS */
        #walnut-hud {
          top: 5px;
          left: 5px;
          padding: 6px 10px;
          font-size: 12px;
          max-width: 150px;
        }
        #walnut-hud div {
          margin: 2px 0;
        }
        #walnut-hud hr {
          display: none !important; /* Hide separator on mobile */
        }
        /* Hide instructions text on mobile (4th div contains instructions) */
        #walnut-hud div:nth-child(4) {
          display: none !important;
        }

        /* MVP 8 Phase 3: Health bar responsive for tablets/phones */
        #health-container {
          margin-top: 2px;
        }
        #health-bar-container {
          min-width: 80px !important;
          height: 14px !important;
        }
        #health-text {
          font-size: 11px;
          min-width: 45px !important;
        }

        /* Make minimap smaller on mobile */
        #minimap {
          width: 120px;
          height: 120px;
          top: 5px;
          right: 5px;
        }

        /* Hide debug overlay on mobile by default */
        #debug-overlay {
          font-size: 10px;
          padding: 5px;
          top: 5px;
          right: 5px;
        }

        /* Mobile-friendly buttons (larger touch targets) - FIX OVERLAP */
        #leaderboard-toggle,
        #settings-toggle {
          padding: 10px 14px;
          font-size: 14px;
          min-height: 48px;
          min-width: 100px;
        }

        /* FIX: Prevent button overlap - stack with proper spacing */
        /* Settings button below minimap */
        #settings-toggle {
          top: 130px; /* Below minimap (120px height + 10px gap) */
          right: 5px;
          bottom: auto;
        }
        /* Mobile action buttons (Hide/Throw/Eat) - ensure enough space from bottom */
        #mobile-actions {
          bottom: 20px;
          right: 5px;
          gap: 8px; /* Reduce gap between buttons */
        }
        /* Leaderboard button - positioned to not overlap mobile-actions */
        /* Mobile-actions takes ~200px height (3 buttons * 64px + 2 gaps * 8px = 208px) */
        #leaderboard-toggle {
          top: auto;
          bottom: 240px; /* 20px (mobile-actions bottom) + 220px (mobile-actions height + padding) */
          right: 5px;
        }

        /* Make leaderboard responsive */
        #leaderboard {
          right: 5px;
          top: auto;
          bottom: 240px; /* Above leaderboard toggle */
          width: calc(100vw - 10px);
          max-width: 300px;
        }

        /* Hide control guide on mobile (not needed with touch controls) */
        #control-guide {
          display: none !important;
        }

        /* Make settings menu mobile-friendly */
        #settings-menu {
          padding: 20px;
          width: 95%;
          max-width: none;
        }
        #settings-menu h2 {
          font-size: 24px;
        }
        .settings-tab {
          font-size: 14px;
          padding: 10px 15px;
        }
        .controls-grid {
          grid-template-columns: 1fr;
        }

        /* Make chat/emotes mobile-friendly (larger touch targets) */
        .chat-button {
          padding: 14px 18px;
          font-size: 14px;
          min-height: 48px;
        }
        .emote-button {
          width: 56px;
          height: 56px;
          font-size: 24px;
        }
        #quick-chat {
          bottom: 10px;
          left: 10px;
        }
        #emotes {
          bottom: 10px;
          right: 10px;
        }

        /* Make toast notifications stack at top-center on mobile */
        #toast-container {
          top: 10px;
          right: auto;
          left: 50%;
          transform: translateX(-50%);
          width: calc(100% - 20px);
          max-width: 400px;
        }
        .toast {
          min-width: auto;
        }

        /* Prevent text selection and improve touch responsiveness */
        body {
          -webkit-user-select: none;
          user-select: none;
          -webkit-tap-highlight-color: transparent;
          -webkit-touch-callout: none;
        }
        button, select {
          -webkit-tap-highlight-color: transparent;
        }
      }

      /* MVP 5.7: iPhone Landscape Orientation Fixes - WITH SAFE AREA SUPPORT */
      @media (max-height: 500px) and (orientation: landscape),
             (max-width: 932px) and (max-height: 430px) and (orientation: landscape) {
        /* CRITICAL: Prevent scrolling in landscape */
        body {
          touch-action: none !important;
          overflow: hidden !important;
        }

        /* SUPER COMPACT HUD - Single line only, respects notch */
        #walnut-hud {
          top: max(5px, env(safe-area-inset-top));
          left: max(5px, env(safe-area-inset-left));
          padding: 4px 8px;
          font-size: 9px;
          max-width: none;
          display: flex;
          flex-direction: row;
          gap: 8px;
          align-items: center;
          background: rgba(139, 69, 19, 0.85);
          border-radius: 4px;
        }
        #walnut-hud div {
          margin: 0;
          display: inline;
        }
        #walnut-hud hr,
        #walnut-hud div:nth-child(3),
        #walnut-hud div:nth-child(4) {
          display: none !important; /* Hide location and instructions in landscape */
        }
        .walnut-icon {
          width: 10px;
          height: 10px;
          margin-right: 3px;
        }

        /* MVP 8 Phase 3: Ultra-compact health bar for landscape mode */
        #health-container {
          margin-top: 0;
        }
        #health-container > div {
          gap: 4px !important;
        }
        #health-container span:first-child {
          font-size: 12px !important; /* Heart emoji */
        }
        #health-bar-container {
          min-width: 50px !important;
          height: 10px !important;
          border-radius: 5px !important;
        }
        #health-text {
          font-size: 8px !important;
          min-width: 35px !important;
        }

        /* Smaller minimap in landscape, respects notch */
        #minimap {
          width: 70px;
          height: 70px;
          top: max(5px, env(safe-area-inset-top));
          right: max(5px, env(safe-area-inset-right));
        }

        /* LANDSCAPE REDESIGN: Settings and Leaderboard at TOP (horizontal), Hide/Throw/Eat on RIGHT */

        /* Settings button - TOP LEFT (next to HUD), horizontal with Leaderboard */
        #settings-toggle {
          top: max(5px, env(safe-area-inset-top));
          left: calc(max(5px, env(safe-area-inset-left)) + 200px); /* After HUD width */
          right: auto;
          bottom: auto;
          padding: 4px 8px;
          font-size: 10px;
          min-width: 70px;
          min-height: 24px;
        }

        /* Leaderboard button - TOP, next to Settings button */
        #leaderboard-toggle {
          top: max(5px, env(safe-area-inset-top));
          left: calc(max(5px, env(safe-area-inset-left)) + 200px + 70px + 5px); /* After HUD + Settings */
          right: auto;
          bottom: auto;
          padding: 4px 8px;
          font-size: 10px;
          min-width: 70px;
          min-height: 24px;
        }

        /* Hide/Throw/Eat buttons - SAME SIZE AS PORTRAIT per user request */
        #mobile-actions {
          top: auto;
          bottom: max(5px, env(safe-area-inset-bottom));
          right: max(5px, env(safe-area-inset-right));
          left: auto;
          flex-direction: column;
          gap: 4px; /* Same as portrait */
        }
        .mobile-action-btn {
          min-width: 50px; /* SAME AS PORTRAIT */
          max-width: 50px;
          min-height: 36px; /* SAME AS PORTRAIT */
          padding: 4px 6px; /* Same as portrait */
          font-size: 9px; /* Same as portrait */
        }
        .mobile-action-btn .btn-icon {
          font-size: 14px; /* Same as portrait */
        }
        .mobile-action-btn .btn-label {
          font-size: 9px; /* Same as portrait */
          line-height: 1;
        }
        .mobile-action-btn .btn-count {
          font-size: 8px; /* Same as portrait */
        }

        /* Leaderboard compact in landscape, respect safe areas */
        #leaderboard {
          bottom: calc(max(5px, env(safe-area-inset-bottom)) + 44px + 36px + 20px);
          right: max(5px, env(safe-area-inset-right));
          width: 180px;
          max-width: 180px;
          font-size: 11px;
          padding: 8px;
        }
        #leaderboard h3 {
          font-size: 13px;
          margin-bottom: 4px;
          padding-bottom: 4px;
        }
        #leaderboard-list li {
          padding: 3px;
          margin: 2px 0;
          font-size: 10px;
        }

        /* Position quick chat at BOTTOM-LEFT, respects notch and home indicator */
        #quick-chat {
          bottom: max(5px, env(safe-area-inset-bottom));
          top: auto;
          left: max(5px, env(safe-area-inset-left));
          transform: none;
          max-height: none;
          overflow-y: visible;
          flex-direction: row; /* Horizontal in landscape */
          gap: 4px;
        }
        .chat-button {
          padding: 6px 8px;
          font-size: 10px;
          min-height: 32px;
          min-width: 70px;
          white-space: nowrap;
        }

        /* Position emotes at BOTTOM-RIGHT corner, respects safe areas */
        #emotes {
          bottom: max(5px, env(safe-area-inset-bottom));
          right: max(5px, env(safe-area-inset-right));
          left: auto; /* Override left positioning */
          flex-direction: row;
          gap: 3px;
        }
        .emote-button {
          width: 32px;
          height: 32px;
          font-size: 14px;
          padding: 4px;
        }

        /* Compact toast notifications in landscape, respect safe areas */
        #toast-container {
          top: max(5px, env(safe-area-inset-top));
          left: 50%;
          right: auto;
          transform: translateX(-50%);
          max-width: 200px;
        }
        .toast {
          padding: 6px 10px;
          font-size: 11px;
        }

        /* Touch hint hidden in landscape (no room) */
        #touch-controls-hint {
          display: none !important;
        }

        /* iOS LANDSCAPE FIX: Compact Settings Menu - Scrollable and Dismissible */
        #settings-menu {
          padding: 10px 15px;
          max-height: 90vh;
          max-height: calc(var(--app-height) * 0.9);
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }
        #settings-menu h2 {
          font-size: 18px;
          margin-bottom: 10px;
        }
        .settings-tabs {
          gap: 5px;
          margin-bottom: 10px;
        }
        .settings-tab {
          font-size: 12px;
          padding: 6px 10px;
        }
        .settings-content {
          padding: 10px;
          min-height: auto;
          max-height: calc(var(--app-height) * 0.4);
          overflow-y: auto;
        }
        .setting-group {
          margin-bottom: 12px;
        }
        .setting-group label {
          font-size: 13px;
          margin-bottom: 4px;
        }
        .controls-grid {
          grid-template-columns: 1fr;
          gap: 8px;
        }
        .control-item {
          padding: 6px;
        }
        .settings-buttons {
          margin-top: 10px;
          position: sticky;
          bottom: 0;
          background: linear-gradient(135deg, #2c5f2d 0%, #4a8f4d 100%);
          padding-top: 10px;
        }
        .settings-button {
          padding: 10px 20px;
          font-size: 14px;
          min-height: 44px; /* iOS touch target */
        }

        /* iOS LANDSCAPE FIX: Compact Leaderboard - Smaller and Positioned Right */
        #leaderboard {
          top: auto;
          bottom: calc(max(5px, env(safe-area-inset-bottom)) + 32px + 5px);
          right: max(5px, env(safe-area-inset-right));
          width: 140px;
          max-width: 140px;
          max-height: calc(var(--app-height) * 0.5);
          overflow-y: auto;
          font-size: 9px;
          padding: 6px;
        }
        #leaderboard h3 {
          font-size: 11px;
          margin-bottom: 3px;
          padding-bottom: 3px;
        }
        #leaderboard-list li {
          padding: 2px;
          margin: 1px 0;
          font-size: 9px;
        }

        /* iOS LANDSCAPE FIX: Horizontal Layout for Character Selection */
        #character-select {
          display: grid;
          grid-template-columns: 180px 1fr;
          grid-template-rows: auto auto 1fr auto;
          gap: 10px;
          padding: 15px;
          width: 90vw;
          max-width: none;
          max-height: calc(var(--app-height) * 0.9);
        }
        /* Title spans both columns */
        #character-select h3 {
          grid-column: 1 / -1;
          font-size: 22px;
          margin: 0;
        }
        /* Preview on the left, spans 3 rows */
        #character-preview-container {
          grid-column: 1;
          grid-row: 2 / 5;
          width: 180px;
          height: 100%;
          min-height: 220px;
        }
        /* Dropdown in top right */
        #character-select select {
          grid-column: 2;
          grid-row: 2;
          font-size: 14px;
          padding: 10px;
          min-height: 48px;
        }
        /* Description in middle right */
        #char-description {
          grid-column: 2;
          grid-row: 3;
          font-size: 12px;
          padding: 10px;
          min-height: 50px;
        }
        /* Button in bottom right */
        #start-btn {
          grid-column: 2;
          grid-row: 4;
          padding: 14px;
          font-size: 17px;
          min-height: 52px;
          align-self: end;
        }
      }

      /* MVP 5.7: Mobile-specific touch controls hint */
      #touch-controls-hint {
        position: fixed; /* Must be fixed like canvas for proper iPad stacking */
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        text-align: center;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        max-width: 90%;
        pointer-events: auto; /* Allow tap to dismiss */
        touch-action: manipulation;
        cursor: pointer;
      }
      #touch-controls-hint.hidden {
        display: none;
      }
      @media (min-width: 769px) {
        #touch-controls-hint {
          display: none !important;
        }
      }

      /* MVP 5.7: Mobile Action Buttons (Hide/Throw walnuts) */
      #mobile-actions {
        position: fixed; /* CRITICAL: Must be fixed like canvas for proper stacking on iPad */
        bottom: 80px;
        right: 20px;
        display: none; /* Hidden until game starts */
        flex-direction: column;
        gap: 12px;
        z-index: 1001; /* Above canvas and game HUD */
        pointer-events: auto; /* Ensure touch events work */
      }
      /* Show ONLY during gameplay on mobile */
      #mobile-actions.visible {
        display: flex;
      }
      .mobile-action-btn {
        background: rgba(139, 69, 19, 0.9);
        color: white;
        border: none;
        border-radius: 12px;
        font-family: 'Arial', sans-serif;
        font-size: 16px;
        font-weight: bold;
        padding: 16px 20px;
        min-width: 120px;
        min-height: 64px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        pointer-events: auto; /* CRITICAL: Ensure touch events work */
        touch-action: manipulation; /* Optimize touch response */
      }
      .mobile-action-btn:active {
        transform: scale(0.95);
        background: rgba(139, 69, 19, 1);
      }
      /* State managed via inline style.opacity (like emote buttons) - no disabled classes needed */
      .mobile-action-btn .btn-icon {
        font-size: 24px;
        line-height: 1;
      }
      .mobile-action-btn .btn-label {
        font-size: 14px;
        line-height: 1;
      }
      .mobile-action-btn .btn-count {
        font-size: 12px;
        opacity: 0.9;
      }
      /* Pulse animation for first-time hint */
      .mobile-action-btn.pulse {
        animation: btnPulse 2s infinite;
      }
      @keyframes btnPulse {
        0%, 100% { box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        50% { box-shadow: 0 4px 20px rgba(255,215,0,0.8); }
      }
      /* iPhone portrait - Clean vertical layout on RIGHT side */
      @media (max-width: 430px) {
        /* Settings button (top) */
        #settings-toggle {
          top: 130px;
          right: 5px;
        }

        /* Leaderboard button (directly under settings) */
        #leaderboard-toggle {
          top: 183px; /* 130 + 48 (settings height) + 5 (gap) */
          right: 5px;
          bottom: auto; /* Override any bottom positioning */
        }

        /* Hide/Throw/Eat buttons (middle-bottom of screen) */
        #mobile-actions {
          right: 5px;
          bottom: 180px; /* Raised higher to avoid bottom clutter */
          gap: 4px;
        }
        .mobile-action-btn {
          min-width: 50px;
          min-height: 36px;
          padding: 4px 6px;
        }
        .mobile-action-btn .btn-icon {
          font-size: 14px;
        }
        .mobile-action-btn .btn-label {
          font-size: 9px;
        }
        .mobile-action-btn .btn-count {
          font-size: 8px;
        }
      }

      /* MVP 5.7: Extra optimizations for small phones (iPhone SE, iPhone 12 mini, etc) - Forest Theme */
      @media (max-width: 430px) {
        #character-select {
          padding: 16px;
          width: 98%;
          gap: 12px;
        }
        #character-select h3 {
          font-size: 22px;
          margin-bottom: 5px;
        }
        #character-preview-container {
          height: 180px;
        }
        #char-description {
          font-size: 13px;
          padding: 10px;
          min-height: 45px;
        }
        #start-btn {
          padding: 16px;
          font-size: 19px;
          min-height: 56px;
        }

        /* Smaller HUD for phones */
        #walnut-hud {
          font-size: 12px;
          padding: 8px 12px;
          max-width: 180px;
        }
        #walnut-hud div {
          margin: 2px 0;
        }
        #walnut-hud hr {
          margin: 4px 0;
        }

        /* MVP 8 Phase 3: Compact health bar for small phones */
        #health-bar-container {
          min-width: 70px !important;
          height: 12px !important;
        }
        #health-text {
          font-size: 10px;
          min-width: 40px !important;
        }

        /* Extra small minimap for phones */
        #minimap {
          width: 100px;
          height: 100px;
        }

        /* Compact touch hint */
        #touch-controls-hint {
          font-size: 12px;
          padding: 10px 15px;
          bottom: 10px;
        }

        /* Smaller emote/chat buttons */
        .emote-button {
          width: 48px;
          height: 48px;
          font-size: 20px;
        }
        .chat-button {
          font-size: 12px;
          padding: 10px 12px;
          min-height: 44px;
        }
      }
    </style>
  </head>
  <body>
    <!-- MVP 5: Loading Screen -->
    <div id="loading-screen" class="hidden">
      <div id="loading-title">Hidden Walnuts</div>
      <div id="loading-progress-container">
        <div id="loading-progress-bar"></div>
      </div>
      <div id="loading-text">Loading assets...</div>
      <div id="loading-percentage">0%</div>
    </div>
    <!-- MVP 5: Toast Notification Container -->
    <div id="toast-container"></div>
    <!-- MVP 5: Score Popup Container -->
    <div id="score-popups"></div>
    <div id="character-select" class="hidden">
      <h3>Select Your Character</h3>
      <div id="character-preview-container">
        <canvas id="character-preview-canvas"></canvas>
      </div>
      <select id="char-select">
        <optgroup label="Mammals">
          <option value="colobus">Colobus Monkey</option>
          <option value="muskrat">Muskrat</option>
          <option value="pudu">Pudu Deer</option>
        </optgroup>
        <optgroup label="Reptiles">
          <option value="gecko">Gecko</option>
          <option value="taipan">Taipan Snake</option>
        </optgroup>
        <optgroup label="Birds">
          <option value="sparrow">Sparrow</option>
        </optgroup>
        <optgroup label="Aquatic">
          <option value="herring">Herring Fish</option>
          <option value="inkfish">Inkfish Squid</option>
        </optgroup>
      </select>
      <div id="char-description">
        <strong>Colobus Monkey</strong>
        Agile tree dweller with excellent mobility. Perfect for quick movements through the forest canopy.
      </div>
      <button id="start-btn">Start Game</button>
    </div>
    <div id="walnut-hud" class="hidden">
      <div>
        <span class="walnut-icon"></span>
        Walnuts: <span id="walnut-count">3</span>
      </div>
      <div>
        ⭐ Score: <span id="player-score">0</span>
      </div>
      <!-- MVP 8 Phase 3: Health Bar -->
      <div id="health-container">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 16px;">❤️</span>
          <div id="health-bar-container" style="flex: 1; min-width: 100px; height: 16px; background: rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3);">
            <div id="health-bar" style="width: 100%; height: 100%; background: linear-gradient(90deg, #ff4444 0%, #ff6666 100%); transition: width 0.3s ease;"></div>
          </div>
          <span id="health-text" style="min-width: 50px; text-align: right; font-weight: bold;">100/100</span>
        </div>
      </div>
    </div>
    <div id="debug-overlay" class="hidden">
      <div>🎮 Position: <span id="player-pos">0, 0, 0</span></div>
      <div>👥 Players: <span id="player-count">0</span></div>
      <div>🌐 Network: <span id="network-status">Disconnected</span></div>
      <div>🆔 ID: <span id="player-id">None</span></div>
      <hr style="margin: 8px 0; border-color: #666;">
      <div>⚡ FPS: <span id="debug-fps">60</span></div>
      <div>💾 Memory: <span id="debug-memory">0 MB</span></div>
      <div>📡 Latency: <span id="debug-latency">0 ms</span></div>
      <hr style="margin: 8px 0; border-color: #666;">
      <div style="font-size: 10px; color: #ccc;">
        Press F to show/hide debug<br>
        WASD/↑←↓→ to move around<br>
        Same spawn: (0, 2, 0)
      </div>
    </div>
    <div id="labels-container"></div>
    <div id="minimap">
      <canvas id="minimap-canvas" width="200" height="200"></canvas>
    </div>
    <button id="leaderboard-toggle" class="hidden">🏆 Leaderboard</button>
    <div id="leaderboard" class="hidden">
      <h3>🏆 Top Players</h3>
      <ul id="leaderboard-list">
        <li>
          <span class="leaderboard-rank">#1</span>
          <span class="leaderboard-name">Loading...</span>
          <span class="leaderboard-score">-</span>
        </li>
      </ul>
    </div>
    <!-- MVP 8 Phase 3: Death Screen Overlay (hidden until player dies in-game) -->
    <div id="death-overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(to bottom, rgba(139, 0, 0, 0) 0%, rgba(139, 0, 0, 0.7) 100%); z-index: 3000; pointer-events: none; opacity: 0; display: none; transition: opacity 0.5s ease;">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
        <div style="font-size: 72px; font-weight: bold; color: #ff4444; text-shadow: 0 0 20px rgba(255, 68, 68, 0.8), 0 0 40px rgba(0, 0, 0, 0.8); font-family: Arial, sans-serif; margin-bottom: 20px;">
          DEFEATED
        </div>
        <div id="death-message" style="font-size: 24px; color: #ffcccc; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8); margin-bottom: 30px; font-family: Arial, sans-serif;">
          You were killed!
        </div>
        <div id="respawn-countdown" style="font-size: 48px; font-weight: bold; color: #ffffff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 2px 8px rgba(0, 0, 0, 0.8); font-family: Arial, sans-serif;">
          Respawning in 3...
        </div>
      </div>
    </div>
    <div id="tutorial-overlay" class="hidden" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.85); color: white; padding: 30px 40px; border-radius: 12px; font-family: 'Arial', sans-serif; font-size: 18px; max-width: 500px; text-align: center; z-index: 2000; box-shadow: 0 8px 16px rgba(0,0,0,0.5);">
      <button id="tutorial-close" style="position: absolute; top: 10px; right: 10px; background: transparent; color: white; border: none; font-size: 24px; cursor: pointer; padding: 5px 10px; line-height: 1;">×</button>
      <div id="tutorial-message" style="margin-bottom: 20px; line-height: 1.6;"></div>
      <button id="tutorial-next" style="background: rgba(139, 69, 19, 0.9); color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s;">Next</button>
    </div>
    <div id="quick-chat" class="hidden">
      <button class="chat-button" data-message="Nice find!">💬 Nice find!</button>
      <button class="chat-button" data-message="Over here!">📍 Over here!</button>
      <button class="chat-button" data-message="Good hiding spot!">👍 Good hiding spot!</button>
      <button class="chat-button" data-message="Want to team up?">🤝 Want to team up?</button>
    </div>
    <div id="emotes" class="hidden">
      <button class="emote-button" data-emote="wave" title="Wave">👋</button>
      <button class="emote-button" data-emote="point" title="Point">👉</button>
      <button class="emote-button" data-emote="celebrate" title="Celebrate">🎉</button>
    </div>
    <div id="chat-message-display"></div>
    <!-- MVP 5.7: Touch Controls Hint (Mobile Only) -->
    <div id="touch-controls-hint" class="hidden">
      <div style="font-weight: bold; margin-bottom: 8px;">📱 Touch Controls</div>
      <div>🕹️ Drag anywhere to move</div>
      <div>👆 Tap walnut to find</div>
      <div>👉 Use HIDE button to bury walnuts</div>
      <div style="margin-top: 8px; font-size: 12px; opacity: 0.7;">Tap here to dismiss</div>
    </div>
    <!-- MVP 5.7: Mobile Action Buttons (Hide/Throw/Eat) -->
    <!-- COPY EMOTE BUTTON PATTERN: Simple buttons, state via style.opacity -->
    <div id="mobile-actions">
      <button id="mobile-hide-btn" class="mobile-action-btn" style="opacity: 0.4" title="Hide Walnut">
        <span class="btn-icon">🥜</span>
        <span class="btn-label">HIDE</span>
        <span class="btn-count" id="mobile-hide-count">(0)</span>
      </button>
      <!-- MVP 8: Throw button -->
      <button id="mobile-throw-btn" class="mobile-action-btn" style="opacity: 0.4" title="Throw Walnut">
        <span class="btn-icon">🌰</span>
        <span class="btn-label">THROW</span>
        <span class="btn-count" id="mobile-throw-count">(0)</span>
      </button>
      <!-- MVP 8 Phase 3: Eat button -->
      <button id="mobile-eat-btn" class="mobile-action-btn" style="opacity: 0.4" title="Eat Walnut (Heal +25 HP)">
        <span class="btn-icon">🍽️</span>
        <span class="btn-label">EAT</span>
        <span class="btn-count" id="mobile-eat-count">(0)</span>
      </button>
    </div>
    <!-- MVP 5: Persistent Control Guide -->
    <div id="control-guide" class="hidden">
      <button id="control-guide-close" title="Dismiss (you can reopen in Settings)">×</button>
      <div class="control-item-inline">
        <span class="control-key-inline">WASD / ↑←↓→</span>
        <span>Move</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">SPACE</span>
        <span>Jump</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">H</span>
        <span>Hide Walnut</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">T</span>
        <span>Throw Walnut</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">Click</span>
        <span>Find</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">M</span>
        <span>Mute</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">F</span>
        <span>Debug</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">ESC</span>
        <span>Settings</span>
      </div>
    </div>
    <!-- MVP 5: Settings Menu -->
    <button id="settings-toggle" class="hidden">⚙️ Settings</button>
    <div id="settings-overlay" class="hidden">
      <div id="settings-menu">
        <h2>⚙️ Settings</h2>
        <div class="settings-tabs">
          <button class="settings-tab active" data-tab="audio">🔊 Audio</button>
          <button class="settings-tab" data-tab="controls">🎮 Controls</button>
        </div>
        <div id="audio-tab" class="settings-content active">
          <div class="setting-group">
            <label>
              Master Volume
              <span class="slider-value" id="master-volume-value">100%</span>
            </label>
            <input type="range" id="master-volume" min="0" max="100" value="100">
          </div>
          <div class="setting-group">
            <label>
              SFX Volume
              <span class="slider-value" id="sfx-volume-value">70%</span>
            </label>
            <input type="range" id="sfx-volume" min="0" max="100" value="70">
          </div>
          <div class="setting-group">
            <label>
              Ambient Volume
              <span class="slider-value" id="ambient-volume-value">50%</span>
            </label>
            <input type="range" id="ambient-volume" min="0" max="100" value="50">
          </div>
          <div class="setting-group">
            <label style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="mute-toggle" style="width: 20px; height: 20px; cursor: pointer;">
              Mute All Audio
            </label>
            <p style="margin: 8px 0 0 0; font-size: 13px; color: #FFE4B5; opacity: 0.8;">
              Shortcut: Press <strong>M</strong> key to toggle mute
            </p>
          </div>
        </div>
        <div id="controls-tab" class="settings-content">
          <div class="setting-group">
            <label>
              Mouse Sensitivity
              <span class="slider-value" id="sensitivity-value">100%</span>
            </label>
            <input type="range" id="mouse-sensitivity" min="25" max="200" value="100">
          </div>
          <div class="setting-group">
            <label>Controls Reference</label>
            <div class="controls-grid">
              <div class="control-item">
                <span class="control-key">WASD / ↑←↓→</span> Move
              </div>
              <div class="control-item">
                <span class="control-key">SPACE</span> Jump
              </div>
              <div class="control-item">
                <span class="control-key">H</span> Hide Walnut
              </div>
              <div class="control-item">
                <span class="control-key">CLICK</span> Find Walnut
              </div>
              <div class="control-item">
                <span class="control-key">M</span> Toggle Mute
              </div>
              <div class="control-item">
                <span class="control-key">F</span> Debug Info
              </div>
              <div class="control-item">
                <span class="control-key">L</span> Leaderboard
              </div>
              <div class="control-item">
                <span class="control-key">ESC</span> Settings
              </div>
            </div>
          </div>
        </div>
        <div class="settings-buttons">
          <button class="settings-button primary" id="settings-apply">Apply & Close</button>
          <button class="settings-button secondary" id="settings-cancel">Cancel</button>
        </div>
      </div>
    </div>
    <canvas id="gameCanvas" class="hidden"></canvas>
    <!-- iOS Safari viewport height fix: Must set CSS variable with window.innerHeight -->
    <script>
      // Fix iOS Safari viewport height issues (address bar, rotation, etc.)
      const setAppHeight = () => {
        const vh = window.innerHeight;
        document.documentElement.style.setProperty('--app-height', `${vh}px`);
        console.log('📐 Viewport height set:', vh, 'px');
      };

      // Set on load
      setAppHeight();

      // Update on resize (address bar show/hide)
      window.addEventListener('resize', setAppHeight);

      // ENHANCED: Fix rotation scrolling issue on iOS Safari
      // User reported: "when rotating the iphone to landscape from portrait, the browser window must be scrolled to show the full canvas"
      window.addEventListener('orientationchange', () => {
        // iOS Safari needs a delay after orientation change for proper recalculation
        setTimeout(() => {
          // Reset document height to force viewport recalculation
          document.documentElement.style.height = 'initial';

          setTimeout(() => {
            // Set new app height based on actual viewport
            setAppHeight();
            document.documentElement.style.height = 'var(--app-height)';

            // Force scroll to top to show full canvas (prevents white space)
            setTimeout(() => {
              window.scrollTo(0, 0);
              console.log('📐 Rotation complete: viewport reset and scrolled to top');
            }, 100);
          }, 100);
        }, 200);
      });
    </script>
    <!-- MVP 7.1: Cloudflare Turnstile Bot Protection -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>