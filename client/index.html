<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hidden Walnuts</title>
    <style>
      body { margin: 0; padding: 0; overflow: hidden; }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 0; /* CRITICAL: Canvas must be behind all UI */
        pointer-events: auto;
      }
      #character-select {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        font-family: 'Arial', sans-serif;
        min-width: 500px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      #character-preview-container {
        width: 100%;
        height: 250px;
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border-radius: 8px;
        border: 2px solid #8B4513;
        overflow: hidden;
        position: relative;
      }
      #character-preview-canvas {
        width: 100%;
        height: 100%;
        display: block;
      }
      #character-select.hidden {
        display: none;
      }
      #character-select h3 {
        margin: 0 0 20px 0;
        color: #2c5f2d;
        font-size: 24px;
        text-align: center;
      }
      #character-select select {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 2px solid #8B4513;
        border-radius: 6px;
        background: white;
        cursor: pointer;
      }
      #character-select select:focus {
        outline: none;
        border-color: #2c5f2d;
      }
      #char-description {
        background: rgba(139, 69, 19, 0.1);
        padding: 15px;
        border-radius: 6px;
        min-height: 60px;
        font-size: 14px;
        color: #333;
        line-height: 1.5;
      }
      #char-description strong {
        color: #8B4513;
        display: block;
        margin-bottom: 5px;
      }
      #start-btn {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        font-weight: bold;
        background: linear-gradient(135deg, #2c5f2d 0%, #4a8f4d 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(44, 95, 45, 0.3);
      }
      #start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(44, 95, 45, 0.4);
      }
      #start-btn:active {
        transform: translateY(0);
      }
      #debug-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        z-index: 1100;
      }
      #debug-overlay.hidden {
        display: none;
      }
      #walnut-hud {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(139, 69, 19, 0.9);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        font-family: 'Arial', sans-serif;
        font-size: 16px;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        pointer-events: none; /* Let touches pass through to canvas */
      }
      #walnut-hud.hidden {
        display: none;
      }
      #walnut-hud div {
        margin: 5px 0;
      }
      .walnut-icon {
        display: inline-block;
        width: 20px;
        height: 20px;
        background: radial-gradient(circle, #8B4513 0%, #654321 100%);
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
      }
      .landmark-label {
        position: absolute;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        pointer-events: none;
        white-space: nowrap;
        transform: translate(-50%, -100%);
      }
      #minimap {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 200px;
        height: 200px;
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        z-index: 1000;
        display: none; /* MVP 5.7: Hidden by default, shown after game starts */
        pointer-events: none; /* Let touches pass through to canvas */
      }
      #minimap.visible {
        display: block;
      }
      #minimap canvas {
        width: 100%;
        height: 100%;
        border-radius: 6px;
      }
      #tutorial-overlay.hidden {
        display: none !important;
      }
      #leaderboard {
        position: absolute;
        top: 10px;
        right: 220px;
        width: 250px;
        background: rgba(44, 95, 45, 0.95);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      }
      #leaderboard.hidden {
        display: none;
      }
      #leaderboard h3 {
        margin: 0 0 10px 0;
        font-size: 18px;
        text-align: center;
        color: #FFD700;
        border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        padding-bottom: 8px;
      }
      #leaderboard-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      #leaderboard-list li {
        padding: 8px;
        margin: 4px 0;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
      }
      #leaderboard-list li:hover {
        background: rgba(0, 0, 0, 0.3);
      }
      #leaderboard-list li.current-player {
        background: rgba(255, 215, 0, 0.2);
        border: 1px solid rgba(255, 215, 0, 0.5);
      }
      .leaderboard-rank {
        font-weight: bold;
        color: #FFD700;
        min-width: 25px;
      }
      .leaderboard-name {
        flex: 1;
        margin: 0 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .leaderboard-score {
        font-weight: bold;
        color: #FFE4B5;
      }
      #leaderboard-toggle {
        position: absolute;
        top: 10px;
        right: 475px;
        background: rgba(44, 95, 45, 0.9);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        font-weight: bold;
        z-index: 1001;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.2s;
        pointer-events: auto;
        touch-action: manipulation;
      }
      #leaderboard-toggle:hover {
        background: rgba(44, 95, 45, 1);
        transform: translateY(-1px);
      }
      #leaderboard-toggle.hidden {
        display: none;
      }
      #quick-chat {
        position: absolute;
        bottom: 20px;
        left: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 1000;
      }
      #quick-chat.hidden {
        display: none;
      }
      .chat-button {
        background: rgba(44, 95, 45, 0.9);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Arial', sans-serif;
        font-size: 13px;
        font-weight: bold;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        min-width: 150px;
        text-align: left;
        pointer-events: auto;
        touch-action: manipulation;
      }
      .chat-button:hover {
        background: rgba(44, 95, 45, 1);
        transform: translateX(3px);
      }
      #emotes {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 8px;
        z-index: 1000;
      }
      #emotes.hidden {
        display: none;
      }
      .emote-button {
        background: rgba(139, 69, 19, 0.9);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        width: 50px;
        height: 50px;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: auto;
        touch-action: manipulation;
      }
      .emote-button:hover {
        background: rgba(139, 69, 19, 1);
        transform: scale(1.1);
      }
      #chat-message-display {
        position: absolute;
        bottom: 200px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        max-width: 300px;
        display: none;
        z-index: 1001;
      }
      #chat-message-display.show {
        display: block;
        animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
      /* MVP 5: Settings Menu Styles */
      #settings-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2500;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #settings-overlay.hidden {
        display: none;
      }
      #settings-menu {
        background: linear-gradient(135deg, #2c5f2d 0%, #4a8f4d 100%);
        border-radius: 12px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 12px 32px rgba(0,0,0,0.5);
        font-family: 'Arial', sans-serif;
        color: white;
      }
      #settings-menu h2 {
        margin: 0 0 20px 0;
        font-size: 28px;
        text-align: center;
        color: #FFD700;
      }
      .settings-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid rgba(255,255,255,0.3);
      }
      .settings-tab {
        padding: 10px 20px;
        background: rgba(0,0,0,0.2);
        border: none;
        border-radius: 8px 8px 0 0;
        color: rgba(255,255,255,0.7);
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      }
      .settings-tab:hover {
        background: rgba(0,0,0,0.3);
        color: white;
      }
      .settings-tab.active {
        background: rgba(255,255,255,0.2);
        color: white;
        border-bottom: 3px solid #FFD700;
      }
      .settings-content {
        display: none;
        padding: 20px;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
        min-height: 300px;
      }
      .settings-content.active {
        display: block;
      }
      .setting-group {
        margin-bottom: 25px;
      }
      .setting-group label {
        display: block;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 8px;
        color: #FFE4B5;
      }
      .setting-group input[type="range"] {
        width: 100%;
        height: 8px;
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
        outline: none;
        cursor: pointer;
      }
      .setting-group input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        background: #FFD700;
        border-radius: 50%;
        cursor: pointer;
      }
      .setting-group input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #FFD700;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }
      .slider-value {
        display: inline-block;
        min-width: 40px;
        text-align: right;
        font-weight: bold;
        color: white;
        margin-left: 10px;
      }
      .controls-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
      }
      .control-item {
        background: rgba(0,0,0,0.3);
        padding: 12px;
        border-radius: 6px;
      }
      .control-key {
        display: inline-block;
        background: rgba(255,215,0,0.3);
        padding: 4px 12px;
        border-radius: 4px;
        font-weight: bold;
        color: #FFD700;
        margin-right: 8px;
        min-width: 50px;
        text-align: center;
      }
      .settings-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: center;
      }
      .settings-button {
        padding: 12px 30px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      }
      .settings-button.primary {
        background: rgba(255,215,0,0.9);
        color: #2c5f2d;
      }
      .settings-button.primary:hover {
        background: rgba(255,215,0,1);
        transform: translateY(-2px);
      }
      .settings-button.secondary {
        background: rgba(0,0,0,0.3);
        color: white;
      }
      .settings-button.secondary:hover {
        background: rgba(0,0,0,0.4);
      }
      #settings-toggle {
        position: absolute;
        top: 220px;
        right: 10px;
        background: rgba(44, 95, 45, 0.9);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        font-weight: bold;
        z-index: 1001;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.2s;
        pointer-events: auto;
        touch-action: manipulation;
      }
      #settings-toggle:hover {
        background: rgba(44, 95, 45, 1);
        transform: translateY(-1px);
      }
      #settings-toggle.hidden {
        display: none;
      }
      /* MVP 5: Persistent Control Guide */
      #control-guide {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-family: 'Arial', sans-serif;
        font-size: 13px;
        z-index: 1000;
        display: flex;
        gap: 20px;
        align-items: center;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transition: opacity 0.3s ease;
      }
      #control-guide.hidden {
        display: none;
      }
      #control-guide-close {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      #control-guide-close:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
      }
      .control-item-inline {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .control-key-inline {
        background: rgba(255,255,255,0.2);
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 12px;
        color: #FFD700;
        min-width: 30px;
        text-align: center;
      }
      .control-separator {
        color: rgba(255,255,255,0.3);
        font-weight: bold;
      }
      /* MVP 5: Loading Progress Bar */
      #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a3a1c 0%, #2c5f2d 100%);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-family: 'Arial', sans-serif;
      }
      #loading-screen.hidden {
        display: none;
      }
      #loading-title {
        font-size: 48px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #FFD700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      }
      #loading-progress-container {
        width: 400px;
        height: 30px;
        background: rgba(0,0,0,0.3);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        margin-bottom: 15px;
      }
      #loading-progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
        transition: width 0.3s ease;
        box-shadow: 0 0 10px rgba(255,215,0,0.5);
      }
      #loading-text {
        font-size: 18px;
        color: #FFE4B5;
        margin-bottom: 10px;
      }
      #loading-percentage {
        font-size: 24px;
        font-weight: bold;
        color: #FFD700;
      }
      /* MVP 5: Toast Notification System */
      #toast-container {
        position: fixed;
        top: 50px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }
      .toast {
        background: rgba(44, 95, 45, 0.95);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        min-width: 250px;
        max-width: 400px;
        pointer-events: auto;
        animation: slideIn 0.3s ease-out;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .toast.success {
        background: rgba(76, 175, 80, 0.95);
        border-left: 4px solid #4CAF50;
      }
      .toast.error {
        background: rgba(244, 67, 54, 0.95);
        border-left: 4px solid #f44336;
      }
      .toast.info {
        background: rgba(33, 150, 243, 0.95);
        border-left: 4px solid #2196F3;
      }
      .toast.warning {
        background: rgba(255, 152, 0, 0.95);
        border-left: 4px solid #FF9800;
      }
      .toast-icon {
        font-size: 20px;
        flex-shrink: 0;
      }
      .toast-message {
        flex: 1;
      }
      .toast.fadeOut {
        animation: slideOut 0.3s ease-in forwards;
      }
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
      /* MVP 5.7: Mobile/Touch-Friendly Styles */
      @media (max-width: 768px), (hover: none) and (pointer: coarse) {
        /* Make character select mobile-friendly */
        #character-select {
          min-width: auto;
          width: 95%;
          max-width: 450px;
          padding: 15px;
        }
        #character-select h3 {
          font-size: 18px;
          margin-bottom: 10px;
        }
        #character-preview-container {
          height: 180px;
        }
        #char-description {
          padding: 10px;
          font-size: 13px;
          min-height: 50px;
        }
        #character-select select {
          font-size: 18px;
          padding: 12px;
          min-height: 48px; /* Touch target minimum */
        }
        #start-btn {
          padding: 18px;
          font-size: 20px;
          min-height: 56px; /* Touch target minimum */
        }

        /* Make HUD mobile-friendly */
        #walnut-hud {
          top: 5px;
          left: 5px;
          padding: 10px 15px;
          font-size: 14px;
          max-width: 200px;
        }
        #walnut-hud div {
          margin: 3px 0;
        }
        #walnut-hud hr {
          margin: 5px 0;
        }

        /* Make minimap smaller on mobile */
        #minimap {
          width: 120px;
          height: 120px;
          top: 5px;
          right: 5px;
        }

        /* Hide debug overlay on mobile by default */
        #debug-overlay {
          font-size: 10px;
          padding: 5px;
          top: 5px;
          right: 5px;
        }

        /* Mobile-friendly buttons (larger touch targets) */
        #leaderboard-toggle,
        #settings-toggle {
          padding: 12px 18px;
          font-size: 16px;
          min-height: 48px;
          min-width: 48px;
        }

        /* Stack leaderboard and settings vertically on mobile */
        #leaderboard-toggle {
          top: auto;
          bottom: 120px;
          right: 5px;
        }
        #settings-toggle {
          top: auto;
          bottom: 60px;
          right: 5px;
        }

        /* Make leaderboard responsive */
        #leaderboard {
          right: 5px;
          top: auto;
          bottom: 180px;
          width: calc(100vw - 10px);
          max-width: 300px;
        }

        /* Hide control guide on mobile (not needed with touch controls) */
        #control-guide {
          display: none !important;
        }

        /* Make settings menu mobile-friendly */
        #settings-menu {
          padding: 20px;
          width: 95%;
          max-width: none;
        }
        #settings-menu h2 {
          font-size: 24px;
        }
        .settings-tab {
          font-size: 14px;
          padding: 10px 15px;
        }
        .controls-grid {
          grid-template-columns: 1fr;
        }

        /* Make chat/emotes mobile-friendly (larger touch targets) */
        .chat-button {
          padding: 14px 18px;
          font-size: 14px;
          min-height: 48px;
        }
        .emote-button {
          width: 56px;
          height: 56px;
          font-size: 24px;
        }
        #quick-chat {
          bottom: 10px;
          left: 10px;
        }
        #emotes {
          bottom: 10px;
          right: 10px;
        }

        /* Make toast notifications stack at top-center on mobile */
        #toast-container {
          top: 10px;
          right: auto;
          left: 50%;
          transform: translateX(-50%);
          width: calc(100% - 20px);
          max-width: 400px;
        }
        .toast {
          min-width: auto;
        }

        /* Prevent text selection and improve touch responsiveness */
        body {
          -webkit-user-select: none;
          user-select: none;
          -webkit-tap-highlight-color: transparent;
          -webkit-touch-callout: none;
        }
        button, select {
          -webkit-tap-highlight-color: transparent;
        }
      }

      /* MVP 5.7: Mobile-specific touch controls hint */
      #touch-controls-hint {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        text-align: center;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        max-width: 90%;
        pointer-events: auto; /* Allow tap to dismiss */
        touch-action: manipulation;
        cursor: pointer;
      }
      #touch-controls-hint.hidden {
        display: none;
      }
      @media (min-width: 769px) {
        #touch-controls-hint {
          display: none !important;
        }
      }

      /* MVP 5.7: Mobile Action Buttons (Hide/Throw walnuts) */
      #mobile-actions {
        position: absolute;
        bottom: 80px;
        right: 20px;
        display: none; /* Hidden by default, shown on mobile via media query */
        flex-direction: column;
        gap: 12px;
        z-index: 1001; /* Above canvas and game HUD */
        pointer-events: auto; /* Ensure touch events work */
      }
      .mobile-action-btn {
        background: rgba(139, 69, 19, 0.9);
        color: white;
        border: none;
        border-radius: 12px;
        font-family: 'Arial', sans-serif;
        font-size: 16px;
        font-weight: bold;
        padding: 16px 20px;
        min-width: 120px;
        min-height: 64px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        pointer-events: auto; /* CRITICAL: Ensure touch events work */
        touch-action: manipulation; /* Optimize touch response */
      }
      .mobile-action-btn:active {
        transform: scale(0.95);
        background: rgba(139, 69, 19, 1);
      }
      .mobile-action-btn:disabled {
        opacity: 0.4;
        background: rgba(100, 100, 100, 0.6);
        cursor: not-allowed;
      }
      .mobile-action-btn .btn-icon {
        font-size: 24px;
        line-height: 1;
      }
      .mobile-action-btn .btn-label {
        font-size: 14px;
        line-height: 1;
      }
      .mobile-action-btn .btn-count {
        font-size: 12px;
        opacity: 0.9;
      }
      /* Pulse animation for first-time hint */
      .mobile-action-btn.pulse {
        animation: btnPulse 2s infinite;
      }
      @keyframes btnPulse {
        0%, 100% { box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        50% { box-shadow: 0 4px 20px rgba(255,215,0,0.8); }
      }
      /* Show on mobile */
      @media (max-width: 768px), (hover: none) and (pointer: coarse) {
        #mobile-actions {
          display: flex;
        }
      }
      /* Adjust position for small phones */
      @media (max-width: 430px) {
        #mobile-actions {
          right: 10px;
          bottom: 70px;
        }
        .mobile-action-btn {
          min-width: 100px;
          min-height: 56px;
          padding: 12px 16px;
        }
        .mobile-action-btn .btn-icon {
          font-size: 20px;
        }
        .mobile-action-btn .btn-label {
          font-size: 13px;
        }
      }

      /* MVP 5.7: Extra optimizations for small phones (iPhone SE, iPhone 12 mini, etc) */
      @media (max-width: 430px) {
        #character-select {
          padding: 12px;
          width: 98%;
        }
        #character-select h3 {
          font-size: 16px;
          margin-bottom: 8px;
        }
        #character-preview-container {
          height: 150px;
        }
        #char-description {
          font-size: 12px;
          padding: 8px;
          min-height: 40px;
        }
        #start-btn {
          padding: 14px;
          font-size: 18px;
        }

        /* Smaller HUD for phones */
        #walnut-hud {
          font-size: 12px;
          padding: 8px 12px;
          max-width: 180px;
        }
        #walnut-hud div {
          margin: 2px 0;
        }
        #walnut-hud hr {
          margin: 4px 0;
        }

        /* Extra small minimap for phones */
        #minimap {
          width: 100px;
          height: 100px;
        }

        /* Compact touch hint */
        #touch-controls-hint {
          font-size: 12px;
          padding: 10px 15px;
          bottom: 10px;
        }

        /* Smaller emote/chat buttons */
        .emote-button {
          width: 48px;
          height: 48px;
          font-size: 20px;
        }
        .chat-button {
          font-size: 12px;
          padding: 10px 12px;
          min-height: 44px;
        }
      }
    </style>
  </head>
  <body>
    <!-- MVP 5: Loading Screen -->
    <div id="loading-screen" class="hidden">
      <div id="loading-title">Hidden Walnuts</div>
      <div id="loading-progress-container">
        <div id="loading-progress-bar"></div>
      </div>
      <div id="loading-text">Loading assets...</div>
      <div id="loading-percentage">0%</div>
    </div>
    <!-- MVP 5: Toast Notification Container -->
    <div id="toast-container"></div>
    <!-- MVP 5: Score Popup Container -->
    <div id="score-popups"></div>
    <div id="character-select">
      <h3>Select Your Character</h3>
      <div id="character-preview-container">
        <canvas id="character-preview-canvas"></canvas>
      </div>
      <select id="char-select">
        <optgroup label="Mammals">
          <option value="colobus">Colobus Monkey</option>
          <option value="muskrat">Muskrat</option>
          <option value="pudu">Pudu Deer</option>
        </optgroup>
        <optgroup label="Reptiles">
          <option value="gecko">Gecko</option>
          <option value="taipan">Taipan Snake</option>
        </optgroup>
        <optgroup label="Birds">
          <option value="sparrow">Sparrow</option>
        </optgroup>
        <optgroup label="Aquatic">
          <option value="herring">Herring Fish</option>
          <option value="inkfish">Inkfish Squid</option>
        </optgroup>
      </select>
      <div id="char-description">
        <strong>Colobus Monkey</strong>
        Agile tree dweller with excellent mobility. Perfect for quick movements through the forest canopy.
      </div>
      <button id="start-btn">Start Game</button>
    </div>
    <div id="walnut-hud" class="hidden">
      <div>
        <span class="walnut-icon"></span>
        Walnuts: <span id="walnut-count">3</span>
      </div>
      <div>
        ⭐ Score: <span id="player-score">0</span>
      </div>
      <div>
        📍 Location: <span id="grid-location">M13</span>
      </div>
      <hr style="margin: 8px 0; border: 0; border-top: 1px solid rgba(255,255,255,0.3);">
      <div style="font-size: 12px; font-weight: normal; color: #FFE4B5;">
        <strong>H</strong> to hide (near bush = 1pt, ground = 3pt)<br>
        <strong>Click</strong> walnut to find<br>
        <strong>Others' walnuts</strong> = points + walnut back<br>
        <strong>Your walnuts</strong> = just walnut back
      </div>
    </div>
    <div id="debug-overlay" class="hidden">
      <div>🎮 Position: <span id="player-pos">0, 0, 0</span></div>
      <div>👥 Players: <span id="player-count">0</span></div>
      <div>🌐 Network: <span id="network-status">Disconnected</span></div>
      <div>🆔 ID: <span id="player-id">None</span></div>
      <hr style="margin: 8px 0; border-color: #666;">
      <div>⚡ FPS: <span id="debug-fps">60</span></div>
      <div>💾 Memory: <span id="debug-memory">0 MB</span></div>
      <div>📡 Latency: <span id="debug-latency">0 ms</span></div>
      <hr style="margin: 8px 0; border-color: #666;">
      <div style="font-size: 10px; color: #ccc;">
        Press F to show/hide debug<br>
        WASD to move around<br>
        Same spawn: (0, 2, 0)
      </div>
    </div>
    <div id="labels-container"></div>
    <div id="minimap">
      <canvas id="minimap-canvas" width="200" height="200"></canvas>
    </div>
    <button id="leaderboard-toggle" class="hidden">🏆 Leaderboard</button>
    <div id="leaderboard" class="hidden">
      <h3>🏆 Top Players</h3>
      <ul id="leaderboard-list">
        <li>
          <span class="leaderboard-rank">#1</span>
          <span class="leaderboard-name">Loading...</span>
          <span class="leaderboard-score">-</span>
        </li>
      </ul>
    </div>
    <div id="tutorial-overlay" class="hidden" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.85); color: white; padding: 30px 40px; border-radius: 12px; font-family: 'Arial', sans-serif; font-size: 18px; max-width: 500px; text-align: center; z-index: 2000; box-shadow: 0 8px 16px rgba(0,0,0,0.5);">
      <button id="tutorial-close" style="position: absolute; top: 10px; right: 10px; background: transparent; color: white; border: none; font-size: 24px; cursor: pointer; padding: 5px 10px; line-height: 1;">×</button>
      <div id="tutorial-message" style="margin-bottom: 20px; line-height: 1.6;"></div>
      <button id="tutorial-next" style="background: rgba(139, 69, 19, 0.9); color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s;">Next</button>
    </div>
    <div id="quick-chat" class="hidden">
      <button class="chat-button" data-message="Nice find!">💬 Nice find!</button>
      <button class="chat-button" data-message="Over here!">📍 Over here!</button>
      <button class="chat-button" data-message="Good hiding spot!">👍 Good hiding spot!</button>
      <button class="chat-button" data-message="Want to team up?">🤝 Want to team up?</button>
    </div>
    <div id="emotes" class="hidden">
      <button class="emote-button" data-emote="wave" title="Wave">👋</button>
      <button class="emote-button" data-emote="point" title="Point">👉</button>
      <button class="emote-button" data-emote="celebrate" title="Celebrate">🎉</button>
    </div>
    <div id="chat-message-display"></div>
    <!-- MVP 5.7: Touch Controls Hint (Mobile Only) -->
    <div id="touch-controls-hint" class="hidden">
      <div style="font-weight: bold; margin-bottom: 8px;">📱 Touch Controls</div>
      <div>🕹️ Drag anywhere to move</div>
      <div>👆 Tap walnut to find</div>
      <div>👉 Use HIDE button to bury walnuts</div>
      <div style="margin-top: 8px; font-size: 12px; opacity: 0.7;">Tap here to dismiss</div>
    </div>
    <!-- MVP 5.7: Mobile Action Buttons (Hide/Throw) -->
    <div id="mobile-actions">
      <button id="mobile-hide-btn" class="mobile-action-btn" title="Hide Walnut">
        <span class="btn-icon">🥜</span>
        <span class="btn-label">HIDE</span>
        <span class="btn-count" id="mobile-hide-count">(3)</span>
      </button>
      <!-- Future MVP 7.2: Throw button
      <button id="mobile-throw-btn" class="mobile-action-btn hidden" title="Throw Walnut">
        <span class="btn-icon">⚾</span>
        <span class="btn-label">THROW</span>
      </button>
      -->
    </div>
    <!-- MVP 5: Persistent Control Guide -->
    <div id="control-guide" class="hidden">
      <button id="control-guide-close" title="Dismiss (you can reopen in Settings)">×</button>
      <div class="control-item-inline">
        <span class="control-key-inline">WASD</span>
        <span>Move</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">SPACE</span>
        <span>Jump</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">H</span>
        <span>Hide Walnut</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">Click</span>
        <span>Find</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">M</span>
        <span>Mute</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">F</span>
        <span>Debug</span>
      </div>
      <span class="control-separator">|</span>
      <div class="control-item-inline">
        <span class="control-key-inline">ESC</span>
        <span>Settings</span>
      </div>
    </div>
    <!-- MVP 5: Settings Menu -->
    <button id="settings-toggle" class="hidden">⚙️ Settings</button>
    <div id="settings-overlay" class="hidden">
      <div id="settings-menu">
        <h2>⚙️ Settings</h2>
        <div class="settings-tabs">
          <button class="settings-tab active" data-tab="audio">🔊 Audio</button>
          <button class="settings-tab" data-tab="controls">🎮 Controls</button>
        </div>
        <div id="audio-tab" class="settings-content active">
          <div class="setting-group">
            <label>
              Master Volume
              <span class="slider-value" id="master-volume-value">100%</span>
            </label>
            <input type="range" id="master-volume" min="0" max="100" value="100">
          </div>
          <div class="setting-group">
            <label>
              SFX Volume
              <span class="slider-value" id="sfx-volume-value">70%</span>
            </label>
            <input type="range" id="sfx-volume" min="0" max="100" value="70">
          </div>
          <div class="setting-group">
            <label>
              Ambient Volume
              <span class="slider-value" id="ambient-volume-value">50%</span>
            </label>
            <input type="range" id="ambient-volume" min="0" max="100" value="50">
          </div>
          <div class="setting-group">
            <label style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="mute-toggle" style="width: 20px; height: 20px; cursor: pointer;">
              Mute All Audio
            </label>
            <p style="margin: 8px 0 0 0; font-size: 13px; color: #FFE4B5; opacity: 0.8;">
              Shortcut: Press <strong>M</strong> key to toggle mute
            </p>
          </div>
        </div>
        <div id="controls-tab" class="settings-content">
          <div class="setting-group">
            <label>
              Mouse Sensitivity
              <span class="slider-value" id="sensitivity-value">100%</span>
            </label>
            <input type="range" id="mouse-sensitivity" min="25" max="200" value="100">
          </div>
          <div class="setting-group">
            <label>Controls Reference</label>
            <div class="controls-grid">
              <div class="control-item">
                <span class="control-key">W A S D</span> Move
              </div>
              <div class="control-item">
                <span class="control-key">SPACE</span> Jump
              </div>
              <div class="control-item">
                <span class="control-key">H</span> Hide Walnut
              </div>
              <div class="control-item">
                <span class="control-key">CLICK</span> Find Walnut
              </div>
              <div class="control-item">
                <span class="control-key">M</span> Toggle Mute
              </div>
              <div class="control-item">
                <span class="control-key">F</span> Debug Info
              </div>
              <div class="control-item">
                <span class="control-key">L</span> Leaderboard
              </div>
              <div class="control-item">
                <span class="control-key">ESC</span> Settings
              </div>
            </div>
          </div>
        </div>
        <div class="settings-buttons">
          <button class="settings-button primary" id="settings-apply">Apply & Close</button>
          <button class="settings-button secondary" id="settings-cancel">Cancel</button>
        </div>
      </div>
    </div>
    <canvas id="gameCanvas" class="hidden"></canvas>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>