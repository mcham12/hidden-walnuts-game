<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="viewport-fit=cover, width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Hidden Walnuts</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;701;800&display=swap" rel="stylesheet">
  <style>
    /* CRITICAL: Prevent iOS Safari white space issues - Use CSS variable set by JS */
    :root {
      --app-height: 100vh;
      /* Fallback, will be set by JavaScript */
    }

    html {
      width: 100vw;
      height: var(--app-height);
      margin: 0;
      padding: 0;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: var(--app-height);
      position: fixed;
      top: 0;
      left: 0;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
    }

    /* CRITICAL: Only style the GAME canvas, not preview canvas */
    #gameCanvas {
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: var(--app-height);
      z-index: 0;
      /* Behind all UI */
      pointer-events: auto;
      touch-action: none;
      background-color: #1b5e20;
      /* Forest green to prevent white flash */
      /* Prevent iOS white space */
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
    }

    /* Global utility class for hiding elements */
    .hidden {
      display: none !important;
    }

    #gameCanvas.hidden {
      display: none;
    }

    /* MVP 5.8: Updated Settings Overlay - Forest Dark Theme */
    #settings-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      backdrop-filter: blur(5px);
    }

    #settings-overlay:not(.hidden) {
      opacity: 1;
      pointer-events: auto;
    }

    #settings-menu {
      background: rgba(40, 40, 40, 0.95);
      border: 4px solid #8B4513;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      font-family: 'Inter', sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      gap: 20px;
      border: 4px solid #8B4513;
    }

    #settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 2px solid rgba(255, 215, 0, 0.3);
      padding-bottom: 15px;
    }

    #settings-header h2 {
      margin: 0;
      color: #FFD700;
      font-size: 28px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    #settings-close-btn {
      background: none;
      border: none;
      color: #FFD700;
      font-size: 32px;
      cursor: pointer;
      line-height: 1;
      transition: transform 0.2s, color 0.2s;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #settings-close-btn:hover {
      transform: scale(1.1);
      color: #fff;
    }

    .settings-section {
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #FFD700;
      margin: 0 0 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid rgba(255, 215, 0, 0.15);
      padding-bottom: 8px;
    }

    .setting-group {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(139, 69, 19, 0.3);
      transition: background 0.2s, border-color 0.2s;
    }

    .setting-group:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(139, 69, 19, 0.6);
    }

    .setting-group label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-weight: 600;
      color: #FFE4B5;
    }

    /* Premium Range Slider Styling */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      background: #2c3e2d;
      border-radius: 4px;
      outline: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      background: #FFD700;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      border: 2px solid #8B4513;
      transition: transform 0.1s;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    /* Premium Checkbox Styling */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      user-select: none;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #FFD700;
      cursor: pointer;
    }

    .settings-group-stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .settings-button-full {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-family: 'Inter', sans-serif;
      margin-top: 10px;
    }

    .settings-button-full.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #FFD700;
      border: 1px solid rgba(255, 215, 0, 0.3);
    }

    .settings-button-full.secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: #FFD700;
      transform: translateY(-2px);
    }

    .account-stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .slider-value {
      color: #FFD700;
      font-weight: 800;
      min-width: 45px;
      text-align: right;
    }

    .btn-gold {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #2c5f2d;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 48px;
      font-family: 'Inter', sans-serif;
    }

    .btn-gold:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 215, 0, 0.6);
      filter: brightness(1.1);
    }

    .btn-gold:active {
      transform: translateY(0);
    }

    #character-select {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #1a4620 0%, #2d5f2e 50%, #4a8f4d 100%);
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
      font-family: 'Arial', sans-serif;
      min-width: 550px;
      z-index: 9000;
      display: flex;
      flex-direction: column;
      gap: 20px;
      border: 3px solid rgba(255, 215, 0, 0.3);
    }

    #character-preview-container {
      width: 100%;
      height: 280px;
      background: linear-gradient(135deg, #2d5f2e 0%, #4a8f4d 100%);
      border-radius: 12px;
      border: 3px solid rgba(255, 215, 0, 0.4);
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    #character-preview-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #character-select.hidden {
      display: none;
    }

    #character-select h3 {
      margin: 0 0 10px 0;
      color: #FFD700;
      font-size: 32px;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      font-weight: 800;
      letter-spacing: 1px;
    }

    .death-mode-section {
      margin: 10px 0;
      padding: 15px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .death-mode-btn {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: white;
      transition: all 0.2s;
      min-width: 140px;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.3);
    }

    #death-mode-standard {
      background: #4CAF50;
    }

    #death-mode-carefree {
      background: #2196F3;
    }

    .death-mode-btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }

    .death-mode-btn:active {
      transform: translateY(1px);
    }

    .death-mode-btn.active {
      box-shadow: 0 0 15px #FFD700;
      border: 2px solid #FFD700;
    }

    #character-select select {
      width: 100%;
      padding: 14px;
      font-size: 17px;
      border: 2px solid rgba(255, 215, 0, 0.5);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.95);
      cursor: pointer;
      font-weight: 600;
      color: #2c5f2d;
      transition: all 0.2s;
    }

    #character-select select:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.4);
    }

    #character-select select:hover {
      border-color: #FFD700;
    }

    #char-description {
      background: rgba(0, 0, 0, 0.3);
      padding: 16px;
      border-radius: 8px;
      min-height: 60px;
      font-size: 15px;
      color: #FFE4B5;
      line-height: 1.6;
      border: 1px solid rgba(255, 215, 0, 0.2);
    }

    #char-description strong {
      color: #FFD700;
      display: block;
      margin-bottom: 6px;
      font-size: 17px;
    }

    #start-btn {
      width: 100%;
      padding: 18px;
      font-size: 22px;
      font-weight: bold;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #2c5f2d;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    #start-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 12px 32px rgba(255, 215, 0, 0.6);
    }

    #start-btn:active {
      transform: translateY(-1px) scale(1.01);
    }

    #debug-overlay {
      position: fixed;
      /* Must be fixed like canvas for proper iPad stacking */
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      z-index: 1100;
    }

    #debug-overlay.hidden {
      display: none;
    }

    #walnut-hud {
      position: fixed;
      /* Must be fixed like canvas for proper iPad stacking */
      top: 10px;
      left: 10px;
      background: rgba(139, 69, 19, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-family: 'Arial', sans-serif;
      font-size: 14px;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      /* Let touches pass through to canvas */
    }

    #walnut-hud.hidden {
      display: none;
    }

    #walnut-hud div {
      margin: 4px 0;
    }

    /* HIDE INSTRUCTIONS FOR ALL PLATFORMS - cleaner HUD */
    #walnut-hud hr {
      display: none !important;
    }

    /* MVP 12: Removed nth-child(4) hide rule - health bar is now 4th child after adding title */
    .walnut-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, #8B4513 0%, #654321 100%);
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
    }

    /* MVP 8 Phase 3: Health Bar Styles (Desktop/Default) */
    #health-container {
      margin-top: 4px;
    }

    .landmark-label {
      position: absolute;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      pointer-events: none;
      white-space: nowrap;
      transform: translate(-50%, -100%);
    }

    #minimap {
      position: fixed;
      /* Must be fixed like canvas for proper iPad stacking */
      top: 10px;
      right: 10px;
      width: 200px;
      height: 200px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      z-index: 1000;
      display: none;
      /* MVP 5.7: Hidden by default, shown after game starts */
      pointer-events: none;
      /* Let touches pass through to canvas */
    }

    #minimap.visible {
      display: block;
    }

    #minimap canvas {
      width: 100%;
      height: 100%;
      border-radius: 6px;
    }

    #leaderboard {
      position: fixed;
      /* Must be fixed like canvas for proper iPad stacking */
      top: 10px;
      right: 220px;
      width: 250px;
      background: rgba(44, 95, 45, 0.95);
      color: white;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Arial', sans-serif;
      font-size: 14px;
      z-index: 2500;
      /* Higher than settings (2000) to appear in front */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    #leaderboard.hidden {
      display: none;
    }

    #leaderboard h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
      text-align: center;
      color: #FFD700;
      border-bottom: 2px solid rgba(255, 215, 0, 0.3);
      padding-bottom: 8px;
    }

    /* MVP 9: Leaderboard tabs styling */
    .leaderboard-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }

    .leaderboard-tab {
      flex: 1;
      background: rgba(0, 0, 0, 0.3);
      color: #ccc;
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      font-family: 'Arial', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
      touch-action: manipulation;
    }

    .leaderboard-tab:hover {
      background: rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 215, 0, 0.4);
    }

    .leaderboard-tab.active {
      background: rgba(255, 215, 0, 0.3);
      color: #FFD700;
      border-color: rgba(255, 215, 0, 0.6);
      font-weight: bold;
    }

    #leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #leaderboard-list li {
      padding: 8px;
      margin: 4px 0;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    #leaderboard-list li:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    #leaderboard-list li.current-player {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid rgba(255, 215, 0, 0.5);
    }

    .leaderboard-rank {
      font-weight: bold;
      color: #FFD700;
      min-width: 25px;
    }

    .leaderboard-name {
      flex: 1;
      margin: 0 8px;
    }

    .leaderboard-score {
      font-weight: bold;
      color: #FFE4B5;
    }

    #leaderboard-toggle {
      position: fixed;
      /* Must be fixed like canvas for proper iPad stacking */
      top: 10px;
      right: 475px;
      background: rgba(44, 95, 45, 0.9);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Arial', sans-serif;
      font-size: 14px;
      font-weight: bold;
      z-index: 1001;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      pointer-events: auto;
      touch-action: manipulation;
      -webkit-appearance: none;
      appearance: none;
    }

    #leaderboard-toggle:hover {
      background: rgba(44, 95, 45, 1);
      transform: translateY(-1px);
    }

    #leaderboard-toggle.hidden {
      display: none;
    }

    #quick-chat {
      position: fixed;
      /* Must be fixed like canvas for proper iPad stacking */
      bottom: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
    }

    #quick-chat.hidden {
      display: none;
    }

    .chat-button {
      background: rgba(44, 95, 45, 0.9);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Arial', sans-serif;
      font-size: 13px;
      font-weight: bold;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      min-width: 150px;
      text-align: left;
      pointer-events: auto;
      touch-action: manipulation;
      -webkit-appearance: none;
      appearance: none;
    }

    .chat-button:hover {
      background: rgba(44, 95, 45, 1);
      transform: translateX(3px);
    }

    #emotes {
      position: fixed;
      /* Must be fixed like canvas for proper iPad stacking */
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      z-index: 1000;
    }

    #emotes.hidden {
      display: none;
    }

    .emote-button {
      background: rgba(139, 69, 19, 0.9);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      width: 50px;
      height: 50px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      touch-action: manipulation;
      -webkit-appearance: none;
      appearance: none;
    }

    .emote-button:hover {
      background: rgba(139, 69, 19, 1);
      transform: scale(1.1);
    }

    #chat-message-display {
      position: fixed;
      /* Must be fixed like canvas for proper iPad stacking */
      bottom: 200px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      font-family: 'Arial', sans-serif;
      font-size: 14px;
      max-width: 300px;
      display: none;
      z-index: 1001;
    }

    #chat-message-display.show {
      display: block;
      animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    /* MVP 5: Settings Menu Styles */
    /* MVP 9: Settings Panel Responsive Styles */
    @media (max-width: 768px) {

      .death-unified-content,
      #settings-menu {
        padding: 20px;
        width: 95%;
      }

      #settings-header h2 {
        font-size: 22px;
      }
    }

    /* iPhone Portrait - Bottom Sheet */
    @media (max-width: 430px) and (orientation: portrait) {
      #settings-overlay {
        align-items: flex-end;
      }

      #settings-menu {
        max-height: 85dvh;
        border-radius: 20px 20px 0 0;
        border-bottom: none;
        width: 100%;
        padding-bottom: env(safe-area-inset-bottom, 20px);
      }
    }

    /* iPhone Landscape */
    @media (max-height: 500px) and (orientation: landscape) {
      #settings-menu {
        max-width: 80%;
        max-height: 95vh;
        padding: 15px;
      }
    }

    #settings-toggle {
      position: fixed;
      /* Must be fixed like canvas for proper iPad stacking */
      top: 220px;
      right: 10px;
      background: rgba(44, 95, 45, 0.9);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Arial', sans-serif;
      font-size: 14px;
      font-weight: bold;
      z-index: 1001;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      pointer-events: auto;
      touch-action: manipulation;
      -webkit-appearance: none;
      appearance: none;
    }

    #settings-toggle:hover {
      background: rgba(44, 95, 45, 1);
      transform: translateY(-1px);
    }

    #settings-toggle.hidden,
    #help-toggle.hidden {
      display: none;
    }

    #help-toggle {
      position: fixed;
      top: 10px;
      right: 605px;
      /* next to leaderboard-toggle (475px + 125px + 5px) */
      background: rgba(44, 95, 45, 0.9);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Arial', sans-serif;
      font-size: 14px;
      font-weight: bold;
      z-index: 1001;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      pointer-events: auto;
      touch-action: manipulation;
      -webkit-appearance: none;
      appearance: none;
    }

    #help-toggle:hover {
      background: rgba(44, 95, 45, 1);
      transform: translateY(-1px);
    }

    /* MVP 5: Loading Progress Bar */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a3a1c 0%, #2c5f2d 100%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: 'Arial', sans-serif;
    }

    #loading-screen.hidden {
      display: none;
    }

    #loading-title {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #FFD700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    #loading-progress-container {
      width: 400px;
      height: 30px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      margin-bottom: 15px;
    }

    #loading-progress-bar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    #loading-text {
      font-size: 18px;
      color: #FFE4B5;
      margin-bottom: 10px;
    }

    #loading-percentage {
      font-size: 24px;
      font-weight: bold;
      color: #FFD700;
    }

    /* MVP 14: Loading Screen Tips */
    #loading-tip {
      margin-top: 30px;
      padding: 16px 24px;
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 12px;
      max-width: 500px;
      font-size: 16px;
      line-height: 1.5;
      color: #FFE4B5;
      text-align: center;
      opacity: 0.9;
    }

    #loading-tip:empty {
      display: none;
    }

    @media (max-width: 768px) {
      #loading-tip {
        max-width: 90%;
        font-size: 14px;
        padding: 12px 18px;
      }
    }

    @media (max-width: 480px) {
      #loading-tip {
        font-size: 13px;
        padding: 10px 14px;
      }
    }

    /* MVP 16: Welcome Screen - Simple Overlay (NO 3D transforms) */
    #welcome-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a4620 0%, #2d5f2e 50%, #4a8f4d 100%);
      z-index: 10001;
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }

    #welcome-screen:not(.hidden) {
      pointer-events: auto;
    }

    .welcome-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
      /* Allow scrolling on small screens */
      overflow-x: hidden;
    }

    /* Simple Card (NO 3D, NO transforms) */
    .welcome-card {
      width: 90%;
      max-width: 400px;
      background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
      border-radius: 24px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(255, 215, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin: auto;
      /* Center vertically and horizontally */
    }

    .card-top {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      /* Issue 1: Reduced from 15px to bring tagline closer to title */
    }

    .card-bottom {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      /* Increased gap for better spacing between squirrel and turnstile */
      margin-top: auto;
      /* Push to bottom of card, respecting the gap */
      flex-shrink: 0;
      /* Prevent buttons from shrinking when space is tight */
    }

    /* Card Title and Tagline */
    .card-title {
      font-size: clamp(24px, 6vw, 32px);
      font-weight: 800;
      margin: 0;
      color: #FFD700;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
      letter-spacing: 1.5px;
      text-align: center;
    }

    .card-tagline {
      font-size: clamp(14px, 3vw, 18px);
      margin: 0;
      color: #FFE4B5;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      font-weight: 300;
      text-align: center;
    }

    /* 3D Character Container */
    .card-character-3d {
      width: 100%;
      height: 260px;
      position: relative;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.2);
      /* Issue 2: Center squirrel vertically */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Turnstile Container */
    .card-turnstile {
      width: 100%;
      max-width: 320px;
      /* Issue 6: Constrain width to match input/button */
      min-height: 65px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      /* Issue 5: Remove background to match card */
      border-radius: 0;
      /* Issue 5: Remove border-radius */
    }

    /* Card Input */
    .card-input {
      width: 100%;
      max-width: 320px;
      padding: 14px 18px;
      font-size: clamp(14px, 3.5vw, 16px);
      border: 3px solid rgba(255, 215, 0, 0.4);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.95);
      color: #2c5f2d;
      font-family: 'Arial', sans-serif;
      font-weight: 600;
      text-align: center;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      box-sizing: border-box;
      /* Ensure border/padding included in width */
    }

    .card-input::placeholder {
      color: rgba(44, 95, 45, 0.5);
      font-weight: 400;
    }

    .card-input:focus {
      border-color: #FFD700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }

    /* Card Button (Primary - Play as Guest) */
    .card-button-primary {
      width: 100%;
      max-width: 320px;
      /* Issue 6: Constrain width to match input/turnstile */
      padding: 16px 24px;
      font-size: clamp(16px, 4vw, 20px);
      font-weight: 800;
      border: none;
      border-radius: 16px;
      background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 8px 24px rgba(50, 205, 50, 0.4);
    }

    .card-button-primary:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(50, 205, 50, 0.6);
    }

    .card-button-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #666;
    }

    /* Auth Links */
    .card-auth-links {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }

    .card-auth-cta {
      font-size: clamp(12px, 3vw, 14px);
      color: #FFD700;
      font-weight: 700;
      margin: 0;
      text-align: center;
    }

    .card-auth-buttons {
      display: flex;
      gap: 12px;
      width: 100%;
    }

    .card-auth-link {
      flex: 1;
      padding: 12px 16px;
      font-size: clamp(13px, 3vw, 15px);
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      text-align: center;
    }

    .card-auth-link-signup {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #8B4513;
      box-shadow: 0 4px 16px rgba(255, 215, 0, 0.3);
    }

    .card-auth-link-signup:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
    }

    .card-auth-link-login {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .card-auth-link-login:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    /* Loading State (Back of Card) */
    .card-loading-title {
      font-size: clamp(28px, 7vw, 36px);
      margin: 0;
      text-align: center;
    }

    .card-progress-container {
      width: 100%;
      height: 20px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) inset;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .card-progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #32CD32 0%, #90EE90 50%, #32CD32 100%);
      background-size: 200% 100%;
      transition: width 0.3s ease;
      border-radius: 8px;
      animation: progressShimmer 2s infinite;
    }

    @keyframes progressShimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .card-loading-text {
      font-size: clamp(16px, 4vw, 20px);
      color: #FFE4B5;
      text-align: center;
      font-weight: 600;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* Decorative elements (kept from old design) */
    .forest-rays {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg,
          transparent 0%,
          rgba(255, 255, 255, 0.03) 25%,
          transparent 50%,
          rgba(255, 255, 255, 0.03) 75%,
          transparent 100%);
      background-size: 200% 200%;
      animation: forestRays 15s ease-in-out infinite;
      z-index: 1;
      pointer-events: none;
    }

    @keyframes forestRays {

      0%,
      100% {
        opacity: 0.3;
        transform: rotate(0deg);
      }

      50% {
        opacity: 0.6;
        transform: rotate(2deg);
      }
    }

    /* Floating leaves */
    .floating-leaf {
      position: absolute;
      font-size: 32px;
      opacity: 0.6;
      animation: floatLeaf 8s ease-in-out infinite;
      z-index: 1;
      pointer-events: none;
    }

    .leaf-1 {
      top: 10%;
      left: 15%;
      animation-delay: 0s;
      animation-duration: 10s;
    }

    .leaf-2 {
      top: 70%;
      left: 80%;
      animation-delay: 2s;
      animation-duration: 12s;
    }

    .leaf-3 {
      top: 30%;
      right: 10%;
      animation-delay: 4s;
      animation-duration: 9s;
    }

    .leaf-4 {
      bottom: 20%;
      left: 25%;
      animation-delay: 6s;
      animation-duration: 11s;
    }

    @keyframes floatLeaf {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
        opacity: 0.4;
      }

      50% {
        transform: translateY(-30px) rotate(180deg);
        opacity: 0.8;
      }
    }

    /* Flip Card Responsive Styles */

    /* Desktop (1025px+) - Default styles already set */

    /* iPad Landscape (768-1024px landscape) */
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
      .welcome-scene {
        max-width: 420px;
        height: auto;
        /* Changed from fixed 550px to auto */
        max-height: 85vh;
        /* Use max-height instead to allow scrolling */
        margin: 0 auto;
        /* Ensure centering */
      }

      .card-face {
        padding: 25px;
        overflow-y: auto;
        /* Ensure scrolling is enabled */
      }

      .card-character-3d {
        height: 180px;
      }
    }

    /* iPad Portrait (768-1024px portrait) */
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
      .welcome-scene {
        max-width: 450px;
        height: 600px;
      }

      .card-character-3d {
        height: 200px;
      }
    }

    /* iPhone Landscape (max-width 932px, max-height 500px) */
    @media (max-width: 932px) and (max-height: 500px) and (orientation: landscape) {
      .welcome-content {
        padding: 10px;
      }

      .welcome-card {
        width: 85vw;
        max-width: 600px;
        padding: 15px;
        gap: 12px;
      }

      .card-top,
      .card-bottom {
        gap: 8px;
      }

      .card-character-3d {
        height: 100px;
      }

      .card-turnstile {
        transform: scale(0.9);
      }
    }

    /* iPhone Portrait (max-width: 430px) */
    @media (max-width: 430px) {
      .welcome-card {
        width: 90%;
        padding: 25px;
      }

      .card-character-3d {
        height: 140px;
      }
    }

    /* Very Small Screens (max-width 374px) */
    @media (max-width: 374px) {
      .welcome-card {
        padding: 20px;
        gap: 16px;
      }

      .card-top,
      .card-bottom {
        gap: 12px;
      }

      .card-character-3d {
        height: 120px;
      }
    }


    /* MVP 16: Unified Death Screen Styles */
    #death-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      z-index: 5000;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease;
      backdrop-filter: blur(5px);
    }

    #death-overlay:not(.hidden) {
      opacity: 1;
      pointer-events: auto;
    }

    .death-unified-content {
      background: rgba(40, 40, 40, 0.95);
      border: 4px solid #8B4513;
      border-radius: 20px;
      padding: 30px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      font-family: 'Arial', sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Top Section: Score + Skip Button */
    .death-top-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .death-score-display {
      text-align: left;
    }

    .death-title {
      font-size: 36px;
      font-weight: 800;
      color: #FFD700;
      margin: 0;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
      font-family: 'Arial', sans-serif;
    }

    .death-score {
      font-size: 18px;
      color: #FFE4B5;
      margin: 5px 0 0 0;
      font-weight: 600;
    }

    #death-score-value {
      color: #FFD700;
      font-weight: bold;
    }

    .death-skip-btn-unified {
      background: #8B4513;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 15px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
      font-family: 'Arial', sans-serif;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .death-skip-btn-unified:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }

    .death-skip-btn-unified:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 rgba(0, 0, 0, 0.3);
    }

    #death-skip-button {
      background: #4CAF50;
      /* Match Standard mode green */
    }

    #death-pause-button {
      background: #666;
    }

    /* Middle Section */
    .death-middle-section {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .death-animation-compact {
      flex-shrink: 0;
    }

    .death-char-emoji {
      font-size: 60px;
      animation: deathPulse 1.5s ease-in-out infinite;
    }

    @keyframes deathPulse {

      0%,
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }

      50% {
        transform: scale(1.2) rotate(5deg);
        opacity: 0.7;
      }
    }

    .respawn-timer-compact {
      flex: 1;
      min-width: 200px;
    }

    .respawn-label {
      font-size: 16px;
      color: #FFE4B5;
      font-weight: bold;
      margin: 0 0 10px 0;
      text-align: center;
    }

    .respawn-progress-container {
      width: 100%;
      height: 24px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid rgba(255, 215, 0, 0.3);
    }

    .respawn-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
      width: 100%;
      transition: width 0.1s linear;
      box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
    }

    /* Bottom Section: Enticement */
    .death-bottom-section {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 2px solid rgba(255, 215, 0, 0.2);
    }

    .death-enticement-panel {
      text-align: center;
    }

    .enticement-title {
      font-size: 20px;
      color: #FFD700;
      margin: 0 0 10px 0;
      font-weight: bold;
    }

    .enticement-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .death-action-btn {
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Arial', sans-serif;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      min-width: 160px;
    }

    .signin-btn {
      background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
      color: white;
    }

    .signin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(40, 167, 69, 0.5);
    }

    .buy-btn {
      background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%);
      color: white;
    }

    .buy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 140, 0, 0.5);
    }

    /* Mode Selection Buttons (Death Screen) */
    .death-mode-btn {
      flex: 1;
      min-width: 140px;
      max-width: 200px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      color: white;
      font-family: 'Arial', sans-serif;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .death-mode-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .death-mode-btn.active {
      background: rgba(255, 215, 0, 0.3);
      border-color: #FFD700;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.4);
    }

    /* Responsive: Mobile Portrait */
    @media (max-width: 430px) and (orientation: portrait) {
      .death-unified-content {
        width: 100%;
        border-radius: 20px 20px 0 0;
        padding: 20px;
        max-height: 85dvh;
      }

      .death-top-section {
        flex-direction: column;
        align-items: flex-start;
      }

      .death-middle-section {
        flex-direction: column;
        gap: 15px;
      }

      .death-mode-btn {
        min-width: 120px;
        font-size: 0.9rem;
        padding: 10px 14px;
      }
    }

    /* Responsive: Mobile Landscape */
    @media (max-height: 500px) and (orientation: landscape) {
      .death-unified-content {
        padding: 15px;
        gap: 12px;
      }

      .death-title {
        font-size: 24px;
      }

      .death-middle-section {
        padding: 10px;
        margin: 5px 0;
      }

      .death-mode-section {
        margin: 10px 0 !important;
        padding: 10px !important;
      }

      .death-mode-section h3 {
        font-size: 0.95rem !important;
        margin-bottom: 10px !important;
      }

      .death-mode-btn {
        min-width: 100px;
        font-size: 0.8rem;
        padding: 8px 12px;
      }

      .death-mode-btn span {
        font-size: 0.65rem !important;
      }
    }

    .watch-ad-link-small {
      display: inline-block;
      margin-top: 10px;
      color: rgba(255, 228, 181, 0.7);
      font-size: 14px;
      text-decoration: underline;
      cursor: pointer;
      transition: color 0.2s;
    }

    .watch-ad-link-small:hover {
      color: #FFE4B5;
      text-decoration: none;
    }

    /* Responsive: Death Screen - Mobile */
    @media (max-width: 768px) {
      .death-unified-content {
        padding: 20px;
      }

      .death-title {
        font-size: 28px;
      }

      .death-score {
        font-size: 16px;
      }

      .death-skip-btn-unified {
        padding: 10px 20px;
        font-size: 14px;
      }

      .death-middle-section {
        flex-direction: column;
        gap: 15px;
      }

      .enticement-title {
        font-size: 18px;
        margin: 0 0 8px 0;
      }

      .death-action-btn {
        font-size: 14px;
        padding: 12px 20px;
        min-width: 140px;
      }

      .death-bottom-section {
        padding-top: 8px;
      }
    }

    /* Responsive: Death Screen - iPhone Landscape */
    @media (max-height: 500px) and (orientation: landscape) {
      .death-unified-content {
        padding: 10px 15px 40px 15px;
        /* Added bottom padding */
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        /* CRITICAL: Re-enable scrolling for this element */
        touch-action: pan-y !important;
        -webkit-overflow-scrolling: touch;
        overflow-y: auto !important;
        pointer-events: auto !important;
        box-sizing: border-box;
      }

      /* Fix minimap overlap with Hide/Throw controls */
      #minimap {
        right: 80px !important;
        top: 10px !important;
      }

      .death-top-section {
        margin-bottom: 5px;
      }

      .death-title {
        font-size: 20px;
      }

      .death-score {
        font-size: 12px;
        margin: 2px 0 0 0;
      }

      .death-skip-btn-unified {
        padding: 8px 16px;
        font-size: 12px;
      }

      .death-middle-section {
        flex-direction: row;
        gap: 10px;
        align-items: center;
        margin: 5px 0;
        padding: 10px;
      }

      .death-char-emoji {
        font-size: 40px;
      }

      .respawn-label {
        font-size: 14px;
        margin: 0 0 5px 0;
      }

      .respawn-progress-container {
        height: 16px;
      }

      .respawn-timer-compact {
        flex: 1;
      }

      .death-bottom-section {
        margin-top: 5px;
        padding-top: 5px;
      }

      .death-enticement-panel {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .enticement-title {
        font-size: 14px;
        margin: 0 0 5px 0;
      }

      /* Make 3D preview smaller in landscape */
      #death-enticement-character-container-anon,
      #death-enticement-character-container-signedin {
        height: 60px !important;
        margin: 0 auto !important;
      }

      .enticement-buttons {
        margin: 5px 0;
        gap: 10px;
      }

      .death-action-btn {
        padding: 8px 16px;
        font-size: 12px;
        min-width: 120px;
      }
    }

    /* MVP 5: Toast Notification System */
    #toast-container {
      position: fixed;
      top: 50px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    /* MVP 14 Phase 9: Desktop - move toasts below minimap to avoid overlap */
    @media (min-width: 1025px) {
      #toast-container {
        top: 220px;
        /* Below 200px minimap + 20px gap */
      }
    }

    .toast {
      background: rgba(44, 95, 45, 0.95);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      font-family: 'Arial', sans-serif;
      font-size: 14px;
      min-width: 250px;
      max-width: 400px;
      pointer-events: auto;
      animation: slideIn 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast.success {
      background: rgba(76, 175, 80, 0.95);
      border-left: 4px solid #4CAF50;
    }

    .toast.error {
      background: rgba(244, 67, 54, 0.95);
      border-left: 4px solid #f44336;
    }

    .toast.info {
      background: rgba(33, 150, 243, 0.95);
      border-left: 4px solid #2196F3;
    }

    .toast.warning {
      background: rgba(255, 152, 0, 0.95);
      border-left: 4px solid #FF9800;
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-message {
      flex: 1;
    }

    .toast.fadeOut {
      animation: slideOut 0.3s ease-in forwards;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    /* MVP 14 Phase 9: Dismissible Tip Card System */
    #tip-card-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9500;
      /* Below overlays (10000) but above game UI (1001) */
      pointer-events: none;
      width: 90%;
      max-width: 600px;
    }

    .tip-card {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.95), rgba(21, 101, 192, 0.95));
      color: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 0 0 2px rgba(33, 150, 243, 0.3);
      pointer-events: auto;
      transform: translateY(150%);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
    }

    .tip-card-visible {
      transform: translateY(0);
      opacity: 1;
    }

    .tip-card-exit {
      transform: translateY(150%);
      opacity: 0;
    }

    .tip-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    #settings-body {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    .tip-card-title {
      font-weight: bold;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tip-card-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      line-height: 1;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .tip-card-close:hover {
      opacity: 1;
    }

    .tip-card-content {
      padding: 16px;
      font-size: 15px;
      line-height: 1.5;
    }

    .tip-card-footer {
      padding: 12px 16px;
      display: flex;
      justify-content: flex-end;
      background: rgba(0, 0, 0, 0.1);
    }

    .tip-card-button {
      background: rgba(255, 255, 255, 0.9);
      color: #1976D2;
      border: none;
      border-radius: 6px;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tip-card-button:hover {
      background: white;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* MVP 14 Phase 9: Mobile/Tablet tip card optimizations */
    @media (max-width: 768px) {
      #tip-card-container {
        width: 95%;
        max-width: 500px;
        bottom: 15px;
      }

      .tip-card-content {
        font-size: 14px;
      }

      .tip-card-button {
        padding: 10px 24px;
        font-size: 15px;
      }
    }

    /* iPhone landscape: smaller tip cards */
    @media (max-height: 500px) and (orientation: landscape) {
      #tip-card-container {
        bottom: 10px;
        width: 80%;
        max-width: 400px;
      }

      .tip-card-content {
        padding: 12px;
        font-size: 13px;
      }

      .tip-card-header {
        padding: 10px 14px;
      }

      .tip-card-footer {
        padding: 10px 14px;
      }
    }

    /* MVP 5.7: Mobile/Touch-Friendly Styles */
    @media (max-width: 768px),
    (hover: none) and (pointer: coarse) {

      /* Make character select mobile-friendly - Forest Theme */
      #character-select {
        min-width: auto;
        width: 95%;
        max-width: 450px;
        max-height: 90vh;
        /* Enable scrolling on mobile */
        padding: 20px;
        gap: 15px;
      }

      #character-select h3 {
        font-size: 24px;
        margin-bottom: 5px;
      }

      #character-preview-container {
        height: 200px;
      }

      #char-description {
        padding: 12px;
        font-size: 14px;
        min-height: 50px;
      }

      #character-select select {
        font-size: 16px;
        padding: 14px;
        min-height: 52px;
        /* Touch target minimum */
      }

      #start-btn {
        padding: 18px;
        font-size: 20px;
        min-height: 60px;
        /* Touch target minimum */
      }

      /* Make HUD mobile-friendly - HIDE INSTRUCTIONS */
      #walnut-hud {
        top: 5px;
        left: 5px;
        padding: 6px 10px;
        font-size: 12px;
        max-width: 200px;
        /* MVP 9 FIX: Increased from 150px to prevent text overflow on iPad */
      }

      #walnut-hud div {
        margin: 2px 0;
      }

      #walnut-hud hr {
        display: none !important;
        /* Hide separator on mobile */
      }

      /* MVP 12: Removed nth-child(4) hide rule - health bar is now 4th child after adding title */

      /* MVP 8 Phase 3: Health bar responsive for tablets/phones */
      #health-container {
        margin-top: 2px;
      }

      #health-bar-container {
        min-width: 80px !important;
        height: 14px !important;
      }

      #health-text {
        font-size: 11px;
        min-width: 45px !important;
      }

      /* Make minimap smaller on mobile */
      #minimap {
        width: 120px;
        height: 120px;
        top: 5px;
        right: 5px;
      }

      /* Hide debug overlay on mobile by default */
      #debug-overlay {
        font-size: 10px;
        padding: 5px;
        top: 5px;
        right: 5px;
      }

      /* Mobile-friendly buttons (larger touch targets) - FIX OVERLAP */
      #leaderboard-toggle,
      #settings-toggle {
        padding: 10px 14px;
        font-size: 14px;
        min-height: 48px;
        min-width: 100px;
      }

      /* FIX: Prevent button overlap - stack with proper spacing */
      /* Settings button below minimap */
      #settings-toggle {
        top: 130px;
        /* Below minimap (120px height + 10px gap) */
        right: 5px;
        bottom: auto;
      }

      /* Mobile action buttons (Hide/Throw/Eat) - ensure enough space from bottom */
      #mobile-actions {
        bottom: 20px;
        right: 5px;
        gap: 8px;
        /* Reduce gap between buttons */
      }

      /* iPad: Leaderboard button - directly under Settings per user request */
      #leaderboard-toggle {
        top: 183px;
        /* 130px (settings top) + 48px (settings height) + 5px (gap) */
        bottom: auto;
        right: 5px;
        padding: 10px 14px;
        /* Same as Settings */
        font-size: 14px;
        /* Same as Settings */
        min-height: 48px;
        /* Same as Settings */
        min-width: 100px;
        /* Same as Settings */
      }

      /* Help button - directly under Leaderboard */
      #help-toggle {
        top: 236px;
        /* 183px (leaderboard top) + 48px (leaderboard height) + 5px (gap) */
        bottom: auto;
        right: 5px;
        padding: 10px 14px;
        font-size: 14px;
        min-height: 48px;
        min-width: 100px;
        background: rgba(44, 95, 45, 0.9);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Arial', sans-serif;
        font-weight: bold;
        z-index: 1001;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
        pointer-events: auto;
        touch-action: manipulation;
        -webkit-appearance: none;
        appearance: none;
      }

      #help-toggle:active {
        background: rgba(44, 95, 45, 1);
      }

      /* Make leaderboard responsive */
      #leaderboard {
        right: 5px;
        top: auto;
        bottom: 240px;
        /* Above leaderboard toggle */
        width: calc(100vw - 10px);
        max-width: 300px;
      }

      /* Make settings menu mobile-friendly */
      #settings-menu {
        padding: 20px;
        width: 95%;
        max-width: none;
      }

      #settings-menu h2 {
        font-size: 24px;
      }

      .settings-tab {
        font-size: 14px;
        padding: 10px 15px;
      }

      .controls-grid {
        grid-template-columns: 1fr;
      }

      /* Make chat/emotes mobile-friendly (larger touch targets) */
      .chat-button {
        padding: 14px 18px;
        font-size: 14px;
        min-height: 48px;
      }

      .emote-button {
        width: 56px;
        height: 56px;
        font-size: 24px;
      }

      #quick-chat {
        bottom: 10px;
        left: 10px;
      }

      #emotes {
        bottom: 10px;
        right: 10px;
      }

      /* MVP 14 Phase 9: Toast notifications left-aligned, leave minimap clear */
      #toast-container {
        top: 10px;
        left: 10px;
        right: auto;
        transform: none;
        width: calc(100% - 140px);
        /* Leave 130px for minimap (120px + 10px gaps) */
        max-width: 300px;
      }

      .toast {
        min-width: auto;
      }

      /* Prevent text selection and improve touch responsiveness */
      body {
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }

      button,
      select {
        -webkit-tap-highlight-color: transparent;
      }
    }

    /* MVP 5.7: iPhone Landscape Orientation Fixes - WITH SAFE AREA SUPPORT */
    @media (max-height: 500px) and (orientation: landscape),
    (max-width: 932px) and (max-height: 430px) and (orientation: landscape) {

      /* CRITICAL: Prevent scrolling in landscape */
      body {
        touch-action: none !important;
        overflow: hidden !important;
      }

      /* MVP 9 FIX: COMPACT HUD - Stack health bar below for better fit */
      #walnut-hud {
        top: max(5px, env(safe-area-inset-top));
        left: max(5px, env(safe-area-inset-left));
        padding: 4px 6px;
        font-size: 9px;
        max-width: 160px;
        /* MVP 9 FIX: Set max width to prevent overflow */
        display: flex;
        flex-direction: column;
        /* MVP 9 FIX: Stack vertically instead of horizontal */
        gap: 2px;
        align-items: flex-start;
        background: rgba(139, 69, 19, 0.85);
        border-radius: 4px;
      }

      #walnut-hud div {
        margin: 0;
        white-space: nowrap;
        /* MVP 9 FIX: Prevent text wrapping */
      }

      /* MVP 9 FIX: Don't hide health container (it's the 3rd div) */
      #walnut-hud hr {
        display: none !important;
        /* Hide any separators */
      }

      .walnut-icon {
        width: 10px;
        height: 10px;
        margin-right: 3px;
      }

      /* MVP 9 FIX: Ultra-compact health bar for landscape mode */
      #health-container {
        margin-top: 0;
        width: 100%;
        /* MVP 9 FIX: Full width within HUD */
      }

      #health-container>div {
        gap: 3px !important;
        display: flex !important;
        align-items: center !important;
      }

      #health-container span:first-child {
        font-size: 10px !important;
        /* Heart emoji */
      }

      #health-bar-container {
        min-width: 60px !important;
        /* MVP 9 FIX: Wider for better visibility */
        height: 8px !important;
        border-radius: 4px !important;
      }

      #health-text {
        font-size: 8px !important;
        min-width: 38px !important;
      }

      /* MVP 14 Phase 9: Minimap same size as portrait (120px) for better visibility */
      #minimap {
        width: 120px;
        height: 120px;
        top: max(5px, env(safe-area-inset-top));
        right: max(5px, env(safe-area-inset-right));
      }

      /* LANDSCAPE REDESIGN: Settings and Leaderboard at TOP (horizontal), Hide/Throw/Eat on RIGHT */

      /* Settings button - TOP LEFT (next to HUD), horizontal with Leaderboard */
      #settings-toggle {
        top: max(5px, env(safe-area-inset-top));
        left: calc(max(5px, env(safe-area-inset-left)) + 200px);
        /* After HUD width */
        right: auto;
        bottom: auto;
        padding: 4px 8px;
        font-size: 10px;
        min-width: 70px;
        min-height: 24px;
      }

      /* Leaderboard button - TOP, next to Settings button */
      #leaderboard-toggle {
        top: max(5px, env(safe-area-inset-top));
        left: calc(max(5px, env(safe-area-inset-left)) + 200px + 70px + 5px);
        /* After HUD + Settings */
        right: auto;
        bottom: auto;
        padding: 4px 8px;
        font-size: 10px;
        min-width: 70px;
        min-height: 24px;
      }

      /* Help button - TOP, next to Leaderboard button */
      #help-toggle {
        top: max(5px, env(safe-area-inset-top));
        left: calc(max(5px, env(safe-area-inset-left)) + 200px + 70px + 5px + 70px + 5px);
        /* After HUD + Settings + Leaderboard */
        right: auto;
        bottom: auto;
        padding: 4px 8px;
        font-size: 10px;
        min-width: 60px;
        min-height: 24px;
        background: rgba(44, 95, 45, 0.9);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-family: 'Arial', sans-serif;
        font-weight: bold;
        z-index: 1001;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
        pointer-events: auto;
        touch-action: manipulation;
        -webkit-appearance: none;
        appearance: none;
      }

      /* Hide/Throw/Eat buttons - moved lower and more left per user request */
      #mobile-actions {
        top: auto;
        bottom: 15px;
        /* Slightly lower (was 5px with safe-area) */
        right: 120px;
        /* More to the left (was 80px) */
        left: auto;
        flex-direction: column;
        gap: 4px;
      }

      .mobile-action-btn {
        min-width: 50px;
        /* SAME AS PORTRAIT */
        max-width: 50px;
        min-height: 36px;
        /* SAME AS PORTRAIT */
        padding: 4px 6px;
        /* Same as portrait */
        font-size: 9px;
        /* Same as portrait */
      }

      .mobile-action-btn .btn-icon {
        font-size: 14px;
        /* Same as portrait */
      }

      .mobile-action-btn .btn-label {
        font-size: 9px;
        /* Same as portrait */
        line-height: 1;
      }

      .mobile-action-btn .btn-count {
        font-size: 8px;
        /* Same as portrait */
      }

      /* Leaderboard compact in landscape, respect safe areas */
      #leaderboard {
        bottom: calc(max(5px, env(safe-area-inset-bottom)) + 44px + 36px + 20px);
        right: max(5px, env(safe-area-inset-right));
        width: 180px;
        max-width: 180px;
        font-size: 11px;
        padding: 8px;
      }

      #leaderboard h3 {
        font-size: 13px;
        margin-bottom: 4px;
        padding-bottom: 4px;
      }

      #leaderboard-list li {
        padding: 3px;
        margin: 2px 0;
        font-size: 10px;
      }

      /* Position quick chat at BOTTOM-LEFT, respects notch and home indicator */
      #quick-chat {
        bottom: max(5px, env(safe-area-inset-bottom));
        top: auto;
        left: max(5px, env(safe-area-inset-left));
        transform: none;
        max-height: none;
        overflow-y: visible;
        flex-direction: row;
        /* Horizontal in landscape */
        gap: 4px;
      }

      .chat-button {
        padding: 6px 8px;
        font-size: 10px;
        min-height: 32px;
        min-width: 70px;
        white-space: nowrap;
      }

      /* Position emotes at BOTTOM-RIGHT corner, respects safe areas */
      #emotes {
        bottom: max(5px, env(safe-area-inset-bottom));
        right: max(5px, env(safe-area-inset-right));
        left: auto;
        /* Override left positioning */
        flex-direction: row;
        gap: 3px;
      }

      .emote-button {
        width: 32px;
        height: 32px;
        font-size: 14px;
        padding: 4px;
      }

      /* Compact toast notifications in landscape - slide from LEFT */
      #toast-container {
        top: max(5px, env(safe-area-inset-top));
        left: max(5px, env(safe-area-inset-left));
        /* Slide from left, not center */
        right: auto;
        transform: none;
        /* Remove center transform */
        max-width: 200px;
      }

      .toast {
        padding: 6px 10px;
        font-size: 11px;
      }

      /* iOS LANDSCAPE FIX: Compact Settings Menu - Scrollable and Dismissible */
      #settings-menu {
        padding: 10px 15px;
        max-height: 90vh;
        max-height: calc(var(--app-height) * 0.9);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      #settings-menu h2 {
        font-size: 18px;
        margin-bottom: 10px;
      }

      .settings-tabs {
        gap: 5px;
        margin-bottom: 10px;
      }

      /* CRITICAL: Tab content visibility */
      .settings-content {
        display: none;
        animation: fadeIn 0.2s ease-out;
      }

      .settings-content.active {
        padding: 10px;
        min-height: auto;
        max-height: calc(var(--app-height) * 0.4);
        overflow-y: auto;
      }

      .setting-group {
        margin-bottom: 12px;
      }

      .setting-group label {
        font-size: 13px;
        margin-bottom: 4px;
      }

      .controls-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .control-item {
        padding: 6px;
      }

      .settings-buttons {
        margin-top: 10px;
        position: sticky;
        bottom: 0;
        background: linear-gradient(135deg, #2c5f2d 0%, #4a8f4d 100%);
        padding-top: 10px;
      }

      .settings-button {
        padding: 10px 20px;
        font-size: 14px;
        min-height: 44px;
        /* iOS touch target */
      }

      /* iOS LANDSCAPE FIX: Compact Leaderboard - Smaller and Positioned Right */
      #leaderboard {
        top: auto;
        bottom: calc(max(5px, env(safe-area-inset-bottom)) + 32px + 5px);
        right: max(5px, env(safe-area-inset-right));
        width: 140px;
        max-width: 140px;
        max-height: calc(var(--app-height) * 0.5);
        overflow-y: auto;
        font-size: 9px;
        padding: 6px;
      }

      #leaderboard h3 {
        font-size: 11px;
        margin-bottom: 3px;
        padding-bottom: 3px;
      }

      #leaderboard-list li {
        padding: 2px;
        margin: 1px 0;
        font-size: 9px;
      }

      /* iOS LANDSCAPE FIX: Horizontal Layout for Character Selection */
      #character-select {
        display: grid;
        grid-template-columns: 180px 1fr;
        grid-template-rows: auto auto 1fr auto;
        gap: 10px;
        padding: 15px;
        width: 90vw;
        max-width: none;
        max-height: calc(var(--app-height) * 0.9);
      }

      /* Title spans both columns */
      #character-select h3 {
        grid-column: 1 / -1;
        font-size: 22px;
        margin: 0;
      }

      /* Preview on the left, spans 3 rows */
      #character-preview-container {
        grid-column: 1;
        grid-row: 2 / 5;
        width: 180px;
        height: 100%;
        min-height: 220px;
      }

      /* Dropdown in top right */
      #character-select select {
        grid-column: 2;
        grid-row: 2;
        font-size: 14px;
        padding: 10px;
        min-height: 48px;
      }

      /* Description in middle right */
      #char-description {
        grid-column: 2;
        grid-row: 3;
        font-size: 12px;
        padding: 10px;
        min-height: 50px;
      }

      /* Button in bottom right */
      #start-btn {
        grid-column: 2;
        grid-row: 4;
        padding: 14px;
        font-size: 17px;
        min-height: 52px;
        align-self: end;
      }
    }

    /* MVP 5.7: Mobile Action Buttons (Hide/Throw walnuts) */
    #mobile-actions {
      position: fixed;
      /* CRITICAL: Must be fixed like canvas for proper stacking on iPad */
      bottom: 80px;
      right: 20px;
      display: none;
      /* Hidden until game starts */
      flex-direction: column;
      gap: 12px;
      z-index: 1001;
      /* Above canvas and game HUD */
      pointer-events: auto;
      /* Ensure touch events work */
    }

    /* Show ONLY during gameplay on mobile */
    #mobile-actions.visible {
      display: flex;
    }

    .mobile-action-btn {
      background: rgba(139, 69, 19, 0.9);
      color: white;
      border: none;
      border-radius: 12px;
      font-family: 'Arial', sans-serif;
      font-size: 9px;
      font-weight: bold;
      padding: 4px 6px;
      min-width: 50px;
      min-height: 36px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      pointer-events: auto;
      /* CRITICAL: Ensure touch events work */
      touch-action: manipulation;
      /* Optimize touch response */
      -webkit-appearance: none;
      appearance: none;
    }

    .mobile-action-btn:active {
      transform: scale(0.95);
      background: rgba(139, 69, 19, 1);
    }

    /* State managed via inline style.opacity (like emote buttons) - no disabled classes needed */
    .mobile-action-btn .btn-icon {
      font-size: 14px;
      line-height: 1;
    }

    .mobile-action-btn .btn-label {
      font-size: 9px;
      line-height: 1;
    }

    .mobile-action-btn .btn-count {
      font-size: 8px;
      opacity: 0.9;
    }

    /* Pulse animation for first-time hint */
    .mobile-action-btn.pulse {
      animation: btnPulse 2s infinite;
    }

    @keyframes btnPulse {

      0%,
      100% {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }

      50% {
        box-shadow: 0 4px 20px rgba(255, 215, 0, 0.8);
      }
    }

    /* iPhone portrait - Clean vertical layout on RIGHT side */
    @media (max-width: 430px) {

      /* Settings button (top) */
      #settings-toggle {
        top: 130px;
        right: 5px;
      }

      /* Leaderboard button (directly under settings) */
      #leaderboard-toggle {
        top: 183px;
        /* 130 + 48 (settings height) + 5 (gap) */
        right: 5px;
        bottom: auto;
        /* Override any bottom positioning */
      }

      /* Hide/Throw/Eat buttons (lower on screen per user request) */
      #mobile-actions {
        right: 5px;
        bottom: 60px;
        /* Lowered from 180px */
        gap: 4px;
      }

      .mobile-action-btn {
        min-width: 50px;
        min-height: 36px;
        padding: 4px 6px;
      }

      .mobile-action-btn .btn-icon {
        font-size: 14px;
      }

      .mobile-action-btn .btn-label {
        font-size: 9px;
      }

      .mobile-action-btn .btn-count {
        font-size: 8px;
      }
    }

    /* MVP 5.7: Extra optimizations for small phones (iPhone SE, iPhone 12 mini, etc) - Forest Theme */
    @media (max-width: 430px) {
      #character-select {
        padding: 16px;
        width: 98%;
        gap: 12px;
      }

      #character-select h3 {
        font-size: 22px;
        margin-bottom: 5px;
      }

      #character-preview-container {
        height: 180px;
      }

      #char-description {
        font-size: 13px;
        padding: 10px;
        min-height: 45px;
      }

      #start-btn {
        padding: 16px;
        font-size: 19px;
        min-height: 56px;
      }

      /* Smaller HUD for phones */
      #walnut-hud {
        font-size: 12px;
        padding: 8px 12px;
        max-width: 180px;
      }

      #walnut-hud div {
        margin: 2px 0;
      }

      #walnut-hud hr {
        margin: 4px 0;
      }

      /* MVP 8 Phase 3: Compact health bar for small phones */
      #health-bar-container {
        min-width: 70px !important;
        height: 12px !important;
      }

      #health-text {
        font-size: 10px;
        min-width: 40px !important;
      }

      /* MVP 14 Phase 9: Minimap same size as tablets (120px) for consistency */
      #minimap {
        width: 120px;
        height: 120px;
      }

      /* Smaller emote/chat buttons */
      .emote-button {
        width: 48px;
        height: 48px;
        font-size: 20px;
      }

      .chat-button {
        font-size: 12px;
        padding: 10px 12px;
        min-height: 44px;
      }
    }

    /* Ensure hidden guides do not block events */
    #control-guide.hidden,
    #touch-controls-hint.hidden {
      display: none !important;
      pointer-events: none !important;
    }
  </style>
</head>

<body>
  <!-- MVP 5: Loading Screen -->
  <div id="loading-screen" class="hidden">
    <div id="loading-title">Hidden Walnuts</div>
    <div id="loading-progress-container">
      <div id="loading-progress-bar"></div>
    </div>
    <div id="loading-text">Loading assets...</div>
    <div id="loading-percentage">0%</div>
    <!-- MVP 14: Gameplay Tips -->
    <div id="loading-tip"></div>
  </div>
  <!-- MVP 5: Toast Notification Container -->
  <div id="toast-container"></div>
  <!-- MVP 14 Phase 9: Dismissible Tip Card Container -->
  <div id="tip-card-container"></div>
  <!-- MVP 5: Score Popup Container -->
  <div id="score-popups"></div>
  <div id="character-select" class="hidden">
    <h3>Select Your Character</h3>
    <div id="character-preview-container">
      <canvas id="character-preview-canvas"></canvas>
    </div>
    <select id="char-select">
      <optgroup label="Mammals">
        <option value="colobus">Colobus Monkey</option>
        <option value="muskrat">Muskrat</option>
        <option value="pudu">Pudu Deer</option>
      </optgroup>
      <optgroup label="Reptiles">
        <option value="gecko">Gecko</option>
        <option value="taipan">Taipan Snake</option>
      </optgroup>
      <optgroup label="Birds">
        <option value="sparrow">Sparrow</option>
      </optgroup>
      <optgroup label="Aquatic">
        <option value="herring">Herring Fish</option>
        <option value="inkfish">Inkfish Squid</option>
      </optgroup>
    </select>
    <div id="char-description">
      <strong>Colobus Monkey</strong>
      Agile tree dweller with excellent mobility. Perfect for quick movements through the forest canopy.
    </div>
    <button id="start-btn">Start Game</button>
  </div>
  <div id="walnut-hud" class="hidden">
    <div>
      <span class="walnut-icon"></span>
      Walnuts: <span id="walnut-count">3</span>
    </div>
    <div>
       Score: <span id="player-score">0</span>
    </div>
    <!-- MVP 12: Player Title Display -->
    <div id="player-title-container">
      <span id="player-title">Rookie Squirrel</span>
    </div>
    <!-- MVP 8 Phase 3: Health Bar -->
    <div id="health-container">
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 16px;"></span>
        <div id="health-bar-container"
          style="position: relative; flex: 1; min-width: 100px; height: 16px; background: rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3);">
          <div id="health-bar"
            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; background: linear-gradient(90deg, #44ff44 0%, #66ff66 100%); transition: width 0.3s ease, background 0.3s ease; margin: 0; padding: 0;">
          </div>
        </div>
        <span id="health-text" style="min-width: 50px; text-align: right; font-weight: bold;">100/100</span>
      </div>
    </div>
  </div>

  <div id="debug-overlay" class="hidden">
    <div> Position: <span id="player-pos">0, 0, 0</span></div>
    <div> Players: <span id="player-count">0</span></div>
    <div> Network: <span id="network-status">Disconnected</span></div>
    <div> ID: <span id="player-id">None</span></div>
    <hr style="margin: 8px 0; border-color: #666;">
    <div> FPS: <span id="debug-fps">60</span></div>
    <div> Memory: <span id="debug-memory">0 MB</span></div>
    <div> Latency: <span id="debug-latency">0 ms</span></div>
    <hr style="margin: 8px 0; border-color: #666;">
    <div style="font-size: 10px; color: #ccc;">
      Press F to show/hide debug<br>
      WASD/ to move around<br>
      Same spawn: (0, 2, 0)
    </div>
  </div>
  <div id="labels-container"></div>
  <div id="minimap">
    <canvas id="minimap-canvas" width="200" height="200"></canvas>
  </div>
  <button id="leaderboard-toggle" class="hidden"> Leaderboard</button>
  <div id="leaderboard" class="hidden">
    <h3> Top Players</h3>
    <!-- MVP 9: Tabs for All-Time vs Weekly -->
    <div class="leaderboard-tabs">
      <button class="leaderboard-tab" data-tab="weekly">Weekly</button>
      <button class="leaderboard-tab" data-tab="alltime">All-Time</button>
    </div>
    <ul id="leaderboard-list">
      <li>
        <span class="leaderboard-rank">#1</span>
        <span class="leaderboard-name">Loading...</span>
        <span class="leaderboard-score">-</span>
      </li>
    </ul>
  </div>
  <!-- MVP 16: Unified Death Screen (single overlay, all content visible) -->
  <div id="death-overlay" class="hidden">
    <div class="death-unified-content">
      <!-- Top Section: Title + Score (Horizontal) -->
      <div class="death-top-section">
        <div class="death-score-display" style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
          <h1 class="death-title">OH NUTS!</h1>
          <p class="death-score" style="margin: 0;">SCORE: <span id="death-score-value">0</span></p>
        </div>
      </div>

      <!-- Middle Section: Respawn Timer + Control Buttons -->
      <div class="death-middle-section">
        <div class="respawn-timer-compact">
          <p class="respawn-label">RESPAWN IN: <span id="respawn-countdown">10</span>s</p>
          <div class="respawn-progress-container">
            <div id="respawn-progress-bar" class="respawn-progress-bar"></div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px; width: 100%;">
          <button id="death-pause-button" class="death-skip-btn-unified" style="flex: 1;">
            PAUSE
          </button>
          <button id="death-skip-button" class="death-skip-btn-unified" style="flex: 1;">
            RESPAWN
          </button>
        </div>
      </div>

      <!-- Mode Selection Section (NEW) -->
      <div class="death-mode-section">
        <h3
          style="margin: 0 0 15px 0; font-size: 1.1rem; color: #FFD700; text-align: center; text-transform: uppercase; letter-spacing: 1px;">
          Respawn Mode</h3>
        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
          <button id="death-mode-carefree" class="death-mode-btn">
            Carefree
            <span style="display: block; font-size: 0.75rem;opacity: 0.8; margin-top: 4px;">
              Relax & explore
            </span>
          </button>
          <button id="death-mode-standard" class="death-mode-btn">
            Standard
            <span style="display: block; font-size: 0.75rem; opacity: 0.8; margin-top: 4px;">
              Compete & climb
            </span>
          </button>
        </div>
      </div>

      <!-- Bottom Section: Enticement (visible from start) -->
      <div class="death-bottom-section">
        <div id="death-content-main" class="death-enticement-panel">
          <h3 class="enticement-title">Choose Your Character!</h3>

          <div id="death-character-preview"
            style="height: 120px; width: 200px; margin: 10px auto; display: flex; justify-content: center; align-items: center;">
            <!-- 3D character will be rendered here by Game.ts -->
          </div>

          <!-- Leaderboard rank below character -->
          <p style="text-align: center; color: #FFD700; font-weight: bold; margin-top: 10px;">
            Your Rank: #<span id="player-rank">--</span>
          </p>

          <!-- Change Character Button -->
          <div class="settings-group-stack" style="align-items: center; margin-top: 15px;">
            <button id="death-change-character-btn" class="btn-gold">
              Change Character
            </button>
          </div>

          <!-- Character Grid Container (Hidden by default) -->
          <div id="death-character-grid-container" class="hidden">
            <!-- CharacterGrid will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="quick-chat" class="hidden">
    <button class="chat-button" data-message="Nice find!"> Nice find!</button>
    <button class="chat-button" data-message="Over here!"> Over here!</button>
    <button class="chat-button" data-message="Good hiding spot!"> Good hiding spot!</button>
    <button class="chat-button" data-message="Want to team up?"> Want to team up?</button>
  </div>
  <div id="emotes" class="hidden">
    <button class="emote-button" data-emote="wave" title="Wave"></button>
    <button class="emote-button" data-emote="point" title="Point"></button>
    <button class="emote-button" data-emote="celebrate" title="Celebrate"></button>
  </div>
  <div id="chat-message-display"></div>
  <!-- MVP 5.7: Mobile Action Buttons (Hide/Throw/Eat) -->
  <!-- COPY EMOTE BUTTON PATTERN: Simple buttons, state via style.opacity -->
  <div id="mobile-actions">
    <button id="mobile-hide-btn" class="mobile-action-btn" style="opacity: 0.4" title="Hide Walnut">
      <span class="btn-icon"></span>
      <span class="btn-label">HIDE</span>
      <span class="btn-count" id="mobile-hide-count">(0)</span>
    </button>
    <!-- MVP 8: Throw button -->
    <button id="mobile-throw-btn" class="mobile-action-btn" style="opacity: 0.4" title="Throw Walnut">
      <span class="btn-icon"></span>
      <span class="btn-label">THROW</span>
      <span class="btn-count" id="mobile-throw-count">(0)</span>
    </button>
    <!-- MVP 8 Phase 3: Eat button -->
    <button id="mobile-eat-btn" class="mobile-action-btn" style="opacity: 0.4" title="Eat Walnut (Heal +25 HP)">
      <span class="btn-icon"></span>
      <span class="btn-label">EAT</span>
      <span class="btn-count" id="mobile-eat-count">(0)</span>
    </button>

  </div>
  <!-- MVP 5: Settings Menu -->
  <button id="settings-toggle" class="hidden"> Settings</button>
  <button id="help-toggle" class="hidden"> Help</button>
  <!-- MVP 5: Settings Menu Overlay -->
  <div id="settings-overlay" class="hidden">
    <div id="settings-menu">
      <div id="settings-header">
        <h2>Settings</h2>
        <!-- Close button for easier access -->
        <button id="settings-close-btn"></button>
      </div>

      <div id="settings-body">
        <!-- All settings in one scrollable view - no tabs -->

        <!-- Audio Settings -->
        <div class="settings-section">
          <h3 class="section-title">Audio</h3>
          <div class="setting-group">
            <label>
              <span>Master Volume</span>
              <span class="slider-value" id="master-volume-value">100%</span>
            </label>
            <input type="range" id="master-volume" min="0" max="100" value="100">
          </div>

          <div class="setting-group">
            <label>
              <span>Music & Ambient</span>
              <span class="slider-value" id="ambient-volume-value">50%</span>
            </label>
            <input type="range" id="ambient-volume" min="0" max="100" value="50">
          </div>

          <div class="setting-group">
            <label>
              <span>Sound Effects</span>
              <span class="slider-value" id="sfx-volume-value">70%</span>
            </label>
            <input type="range" id="sfx-volume" min="0" max="100" value="70">
          </div>

          <div class="setting-group">
            <label class="checkbox-label">
              <input type="checkbox" id="mute-toggle">
              <span>Mute All Audio</span>
            </label>
          </div>
        </div>

        <!-- Tips Section -->
        <div class="settings-section">
          <h3 class="section-title">Tips</h3>
          <div id="tips-container" class="settings-group-stack">
            <!-- Tips populated by JS -->
          </div>
          <button id="reset-tips-btn" class="settings-button-full secondary">Reset Seen Tips</button>
        </div>

        <!-- Account Section -->
        <div class="settings-section">
          <h3 class="section-title">Account</h3>
          <div id="account-container" class="account-stack">
            <!-- Account info populated by JS -->
          </div>
        </div>
      </div>
    </div>
  </div>
  <canvas id="gameCanvas" class="hidden"></canvas>
  <!-- iOS Safari viewport height fix: Must set CSS variable with window.innerHeight -->
  <script>
    // Fix iOS Safari viewport height issues (address bar, rotation, etc.)
    const setAppHeight = () => {
      const vh = window.innerHeight;
      document.documentElement.style.setProperty('--app-height', `${vh}px`);
      console.log(' Viewport height set:', vh, 'px');
    };

    // Set on load
    setAppHeight();

    // Update on resize (address bar show/hide)
    window.addEventListener('resize', setAppHeight);

    // ENHANCED: Fix rotation scrolling issue on iOS Safari
    // User reported: "when rotating the iphone to landscape from portrait, the browser window must be scrolled to show the full canvas"
    window.addEventListener('orientationchange', () => {
      // iOS Safari needs a delay after orientation change for proper recalculation
      setTimeout(() => {
        // Reset document height to force viewport recalculation
        document.documentElement.style.height = 'initial';

        setTimeout(() => {
          // Set new app height based on actual viewport
          setAppHeight();
          document.documentElement.style.height = 'var(--app-height)';

          // Force scroll to top to show full canvas (prevents white space)
          setTimeout(() => {
            window.scrollTo(0, 0);
            console.log(' Rotation complete: viewport reset and scrolled to top');
          }, 100);
        }, 100);
      }, 200);
    });
  </script>
  <!-- MVP 7.1: Cloudflare Turnstile Bot Protection -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script type="module" src="/src/main.ts"></script>
  <!-- MVP 16: Auth Modal Root -->
  <div id="auth-modal-root"></div>
</body>

</html>